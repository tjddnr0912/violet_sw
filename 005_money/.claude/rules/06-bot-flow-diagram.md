# 06. 봇 동작 구조 다이어그램

## 1. 전체 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           TradingBotV3                                   │
│                        (trading_bot_v3.py)                               │
│  ┌─────────────────────────────────────────────────────────────────┐    │
│  │                         Main Loop                                │    │
│  │                    (15분 주기 실행)                              │    │
│  └─────────────────────────────────────────────────────────────────┘    │
│         │                    │                    │                      │
│         ▼                    ▼                    ▼                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────────┐            │
│  │ StrategyV3  │     │ Portfolio   │     │ Telegram        │            │
│  │             │     │ ManagerV3   │     │ Notifier        │            │
│  └─────────────┘     └─────────────┘     └─────────────────┘            │
│         │                    │                    │                      │
│         ▼                    ▼                    ▼                      │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────────┐            │
│  │ Regime      │     │ Live        │     │ Telegram        │            │
│  │ Detector    │     │ ExecutorV3  │     │ Bot Handler     │            │
│  └─────────────┘     └─────────────┘     └─────────────────┘            │
│         │                    │                                           │
│         ▼                    ▼                                           │
│  ┌─────────────┐     ┌─────────────┐                                    │
│  │ Dynamic     │     │ Bithumb     │                                    │
│  │ Factor Mgr  │     │ API         │                                    │
│  └─────────────┘     └─────────────┘                                    │
└─────────────────────────────────────────────────────────────────────────┘
```

## 2. 메인 분석 루프 플로우

```
                              ┌─────────────┐
                              │   START     │
                              │  (봇 시작)   │
                              └──────┬──────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Initialize Bot       │
                         │  - Load config        │
                         │  - Init components    │
                         │  - Start Telegram     │
                         └───────────┬───────────┘
                                     │
                                     ▼
                         ┌───────────────────────┐
                         │  Send Startup         │
                         │  Notification         │
                         └───────────┬───────────┘
                                     │
          ┌──────────────────────────┴──────────────────────────┐
          │                    MAIN LOOP                         │
          │                  (while running)                     │
          │  ┌────────────────────────────────────────────────┐ │
          │  │                                                │ │
          │  │    ┌─────────────────────────────────────┐     │ │
          │  │    │   For each coin in [BTC, ETH, XRP]  │     │ │
          │  │    └──────────────────┬──────────────────┘     │ │
          │  │                       │                        │ │
          │  │                       ▼                        │ │
          │  │           ┌──────────────────────┐             │ │
          │  │           │   analyze_market()   │             │ │
          │  │           └──────────┬───────────┘             │ │
          │  │                      │                         │ │
          │  │                      ▼                         │ │
          │  │           ┌──────────────────────┐             │ │
          │  │           │   process_signal()   │             │ │
          │  │           └──────────────────────┘             │ │
          │  │                                                │ │
          │  └────────────────────────────────────────────────┘ │
          │                          │                          │
          │                          ▼                          │
          │              ┌──────────────────────┐               │
          │              │  Sleep 15 minutes    │               │
          │              └──────────────────────┘               │
          │                          │                          │
          └──────────────────────────┴──────────────────────────┘
```

## 3. 시장 분석 상세 플로우 (analyze_market)

```
┌─────────────────┐
│ analyze_market  │
│     (coin)      │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────┐
│  1. Get Price Data              │
│  ─────────────────────          │
│  • Daily candles (레짐 판단)     │
│  • 4H candles (진입 신호)        │
│                                 │
│  bithumb_api.get_candlestick()  │
└────────────────┬────────────────┘
                 │
                 ▼
┌─────────────────────────────────┐
│  2. Detect Market Regime        │
│  ─────────────────────          │
│  • Calculate EMA50, EMA200      │
│  • Calculate ADX                │
│  • Determine regime:            │
│    - strong_bullish (>+5%)      │
│    - bullish (+2%~+5%)          │
│    - neutral (-2%~+2%)          │
│    - bearish (-5%~-2%)          │
│    - strong_bearish (<-5%)      │
│    - ranging (ADX<20)           │
└────────────────┬────────────────┘
                 │
                 ▼
┌─────────────────────────────────┐
│  3. Update Dynamic Factors      │
│  ─────────────────────          │
│  • Calculate ATR%               │
│  • Determine volatility level   │
│  • Adjust parameters:           │
│    - Position size multiplier   │
│    - Chandelier multiplier      │
│    - Entry thresholds           │
└────────────────┬────────────────┘
                 │
                 ▼
┌─────────────────────────────────┐
│  4. Calculate Entry Score       │
│  ─────────────────────          │
│  Score = 0                      │
│                                 │
│  if (price <= BB_lower):        │
│      score += 1.0  (BB Touch)   │
│                                 │
│  if (RSI < threshold):          │
│      score += 1.0  (RSI OS)     │
│                                 │
│  if (Stoch_K cross > Stoch_D):  │
│      score += 2.0  (Stoch)      │
│                                 │
│  Max Score = 4.0                │
└────────────────┬────────────────┘
                 │
                 ▼
┌─────────────────────────────────┐
│  5. Determine Action            │
│  ─────────────────────          │
│                                 │
│  if (has_position):             │
│      check_exit_conditions()    │
│  else:                          │
│      if (score >= min_score):   │
│          action = BUY           │
│      else:                      │
│          action = HOLD          │
└────────────────┬────────────────┘
                 │
                 ▼
┌─────────────────────────────────┐
│  Return Analysis Result         │
│  ─────────────────────          │
│  {                              │
│    'action': 'BUY/SELL/HOLD',   │
│    'regime': 'bearish',         │
│    'entry_score': 2.5,          │
│    'indicators': {...},         │
│    'dynamic_factors': {...}     │
│  }                              │
└─────────────────────────────────┘
```

## 4. 포지션 처리 플로우 (process_signal)

```
                    ┌─────────────────┐
                    │ process_signal  │
                    │ (coin, result)  │
                    └────────┬────────┘
                             │
                             ▼
                    ┌─────────────────┐
                    │  Has Position?  │
                    └────────┬────────┘
                             │
             ┌───────────────┴───────────────┐
             │                               │
            YES                              NO
             │                               │
             ▼                               ▼
    ┌─────────────────┐             ┌─────────────────┐
    │ Check Exit      │             │ Action = BUY?   │
    │ Conditions      │             └────────┬────────┘
    └────────┬────────┘                      │
             │                    ┌──────────┴──────────┐
             ▼                    │                     │
    ┌─────────────────┐          YES                   NO
    │ Stop Loss Hit?  │           │                     │
    └────────┬────────┘           ▼                     ▼
             │           ┌─────────────────┐   ┌─────────────────┐
      ┌──────┴──────┐    │ Check Position  │   │     HOLD        │
      │             │    │ Limit           │   │   (No Action)   │
     YES           NO    └────────┬────────┘   └─────────────────┘
      │             │             │
      ▼             ▼      ┌──────┴──────┐
┌──────────┐  ┌──────────┐ │             │
│  CLOSE   │  │ Profit   │ │ Limit OK    │ Position Full
│ Position │  │ Target?  │ │             │      │
│ (손절)   │  └────┬─────┘ ▼             ▼
└──────────┘       │  ┌──────────┐  ┌──────────┐
                   │  │ OPEN     │  │  HOLD    │
            ┌──────┴──────┐      │  │Position  │  (대기)
            │             │      │  └──────────┘
           YES           NO      │
            │             │      │
            ▼             ▼      │
      ┌──────────┐  ┌──────────┐ │
      │  CLOSE   │  │  HOLD    │ │
      │ Position │  │(유지)    │ │
      │ (익절)   │  └──────────┘ │
      └──────────┘               │
                                 │
                                 ▼
                        ┌─────────────────┐
                        │ Execute Order   │
                        │ (LiveExecutor)  │
                        └────────┬────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │ Send Telegram   │
                        │ Notification    │
                        └─────────────────┘
```

## 5. 청산 조건 체크 플로우

```
┌─────────────────────────────────────────────────────────────┐
│                  Check Exit Conditions                       │
└─────────────────────────────────────────────────────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │     1. STOP LOSS CHECK       │
              │     (Chandelier Exit)        │
              │                              │
              │  stop_price = entry_price    │
              │    - (ATR × chandelier_mult) │
              │                              │
              │  if (current <= stop_price): │
              │      EXIT = TRUE             │
              └──────────────┬───────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │     2. PROFIT TARGET CHECK   │
              │                              │
              │  [추세추종 모드]              │
              │  TP1: BB Upper 도달 → 50%청산 │
              │  TP2: 2.5R 도달 → 전량청산    │
              │                              │
              │  [평균회귀 모드]              │
              │  BB Middle 도달 → 전량청산    │
              └──────────────┬───────────────┘
                             │
                             ▼
              ┌──────────────────────────────┐
              │     3. TIME-BASED CHECK      │
              │                              │
              │  if (holding_time > max):    │
              │      consider exit           │
              └──────────────────────────────┘
```

## 6. 동적 파라미터 업데이트 주기

```
┌─────────────────────────────────────────────────────────────────┐
│                  Dynamic Factor Update Cycle                     │
└─────────────────────────────────────────────────────────────────┘

     실시간 (매 분석)          4시간마다           일간
     ─────────────          ──────────         ──────
          │                     │                 │
          ▼                     ▼                 ▼
   ┌─────────────┐      ┌─────────────┐    ┌─────────────┐
   │ ATR%        │      │ BB Period   │    │ Market      │
   │ Volatility  │      │ Stoch K/D   │    │ Regime      │
   │ Level       │      │ RSI Period  │    │ Entry Mode  │
   └─────────────┘      └─────────────┘    └─────────────┘
          │                     │                 │
          ▼                     ▼                 ▼
   ┌─────────────┐      ┌─────────────┐    ┌─────────────┐
   │ Position    │      │ Entry       │    │ Take Profit │
   │ Size Mult   │      │ Thresholds  │    │ Target Mode │
   │ Chandelier  │      │ (RSI/Stoch) │    │ Full Exit   │
   │ Multiplier  │      │             │    │ Flag        │
   └─────────────┘      └─────────────┘    └─────────────┘


     주간 (월요일 0시)        월간 (1일 0시)
     ────────────────        ─────────────
          │                       │
          ▼                       ▼
   ┌─────────────┐         ┌─────────────┐
   │ Entry       │         │ Risk        │
   │ Weights     │         │ Parameters  │
   │ (BB/RSI/    │         │ Optimization│
   │  Stoch)     │         │             │
   │ Min Score   │         │             │
   └─────────────┘         └─────────────┘
```

## 7. 텔레그램 통신 플로우

```
┌───────────────────────────────────────────────────────────────────┐
│                     Telegram Communication                         │
└───────────────────────────────────────────────────────────────────┘

     ┌──────────────┐                      ┌──────────────┐
     │   USER       │                      │  TRADING     │
     │  (Telegram)  │                      │    BOT       │
     └──────┬───────┘                      └──────┬───────┘
            │                                     │
            │  ─────────── Commands ───────────▶  │
            │  /status, /positions, /factors      │
            │  /close BTC, /stop                  │
            │                                     │
            │                                     │
            │  ◀─────── Notifications ─────────  │
            │  • Trade alerts (BUY/SELL)         │
            │  • Regime change alerts            │
            │  • Daily summary                   │
            │  • Factor updates                  │
            │                                     │

┌─────────────────────────────────────────────────────────────────┐
│  Command Flow: /close BTC                                        │
│                                                                  │
│  User                    Bot Handler               Executor      │
│   │                          │                        │          │
│   │  /close BTC              │                        │          │
│   │─────────────────────────▶│                        │          │
│   │                          │                        │          │
│   │  [Position Details]      │                        │          │
│   │  [Close] [Cancel]        │                        │          │
│   │◀─────────────────────────│                        │          │
│   │                          │                        │          │
│   │  Click [Close]           │                        │          │
│   │─────────────────────────▶│                        │          │
│   │                          │                        │          │
│   │                          │  close_position()      │          │
│   │                          │───────────────────────▶│          │
│   │                          │                        │          │
│   │                          │  Result                │          │
│   │                          │◀───────────────────────│          │
│   │                          │                        │          │
│   │  "Position Closed"       │                        │          │
│   │  P&L: +150,000 KRW       │                        │          │
│   │◀─────────────────────────│                        │          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 8. 전체 데이터 흐름 요약

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Data Flow Summary                             │
└─────────────────────────────────────────────────────────────────────┘

                         ┌─────────────┐
                         │  Bithumb    │
                         │  Exchange   │
                         └──────┬──────┘
                                │
                    ┌───────────┴───────────┐
                    │   OHLCV Data          │
                    │   (4H, Daily)         │
                    └───────────┬───────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                                                                      │
│   ┌───────────┐     ┌───────────┐     ┌───────────┐                 │
│   │  Regime   │     │ Indicator │     │ Dynamic   │                 │
│   │  Detect   │     │  Calc     │     │ Factors   │                 │
│   └─────┬─────┘     └─────┬─────┘     └─────┬─────┘                 │
│         │                 │                 │                        │
│         └────────────┬────┴─────────────────┘                        │
│                      │                                               │
│                      ▼                                               │
│              ┌───────────────┐                                       │
│              │ Entry Score   │                                       │
│              │ Calculation   │                                       │
│              └───────┬───────┘                                       │
│                      │                                               │
│                      ▼                                               │
│              ┌───────────────┐                                       │
│              │   Decision    │                                       │
│              │  BUY/SELL/    │                                       │
│              │    HOLD       │                                       │
│              └───────┬───────┘                                       │
│                      │                                               │
└──────────────────────┼───────────────────────────────────────────────┘
                       │
           ┌───────────┴───────────┐
           │                       │
           ▼                       ▼
    ┌─────────────┐         ┌─────────────┐
    │  Execute    │         │  Telegram   │
    │  Order      │         │  Notify     │
    └──────┬──────┘         └─────────────┘
           │
           ▼
    ┌─────────────┐
    │  Update     │
    │  Position   │
    │  State      │
    └──────┬──────┘
           │
           ▼
    ┌─────────────┐
    │  Log &      │
    │  Persist    │
    └─────────────┘
```
