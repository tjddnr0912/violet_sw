# Ver3 거래 이론 및 점수 계산

**버전:** Ver3 - Portfolio Multi-Coin Strategy
**최종 업데이트:** 2025-10-08
**기반 전략:** Ver2 Multi-Timeframe Stability Strategy

---

## 전략 개요

Ver3는 **Ver2의 다중 시간대 전략을 여러 코인에 동시 적용**하는 포트폴리오 관리 시스템입니다.

### 핵심 원리

Ver3는 세 가지 핵심 원리로 작동합니다:

1. **일봉 체제 필터** (Daily Timeframe)
   - 시장의 장기 방향을 판단
   - 상승 체제에서만 거래 허용

2. **4시간봉 점수 계산** (4H Timeframe)
   - 진입/청산 타이밍 결정
   - 점수 기반 신호 생성

3. **포트폴리오 리스크 관리**
   - 최대 2개 포지션 제한
   - 점수 높은 코인 우선 진입

### 전략 흐름도

```
┌─────────────────────────────────────────────────────┐
│ 1. 일봉 체제 필터 (Daily EMA 50/200)                │
│    - 상승 체제 확인 (Golden Cross)                   │
│    - 하락 체제면 거래 불가                           │
└──────────────┬──────────────────────────────────────┘
               ↓ (체제 OK)
┌─────────────────────────────────────────────────────┐
│ 2. 4시간봉 진입 점수 계산 (최대 4점)                 │
│    - 볼린저 밴드 터치: 1점                           │
│    - RSI 과매도: 1점                                │
│    - 스토캐스틱 골든크로스: 2점                      │
│    - 일봉 상승 체제: (보너스 조건)                   │
└──────────────┬──────────────────────────────────────┘
               ↓ (점수 2점 이상)
┌─────────────────────────────────────────────────────┐
│ 3. 포트폴리오 의사결정                               │
│    - 현재 포지션 수 확인 (0/2, 1/2, 2/2)            │
│    - 진입 후보 점수 비교                            │
│    - 최대 포지션 제한 적용                          │
└──────────────┬──────────────────────────────────────┘
               ↓ (진입 확정)
┌─────────────────────────────────────────────────────┐
│ 4. 주문 실행 및 포지션 관리                          │
│    - 매수 주문 전송                                 │
│    - 샹들리에 엑시트 손절 설정                       │
│    - 목표가 도달 시 부분 청산                        │
└─────────────────────────────────────────────────────┘
```

---

## 진입 점수 계산 (Entry Scoring)

### 점수 구성 (총 4점)

Ver3는 4가지 조건을 평가하여 진입 점수를 계산합니다. **최소 2점 이상**이면 진입 신호가 발생합니다.

---

#### 조건 1: 볼린저 밴드 터치 (1점)

**측정 방법:**
- 현재 캔들의 저가(Low)가 볼린저 밴드 하단선(Lower Band)에 근접했는지 확인

**계산 공식:**
```
볼린저 밴드 하단선 = MA(20) - 2 × StdDev(20)

조건:
저가 <= 하단선  →  1점 획득
```

**점수 부여 조건:**
```python
if latest['low'] <= latest['bb_lower']:
    score += 1  # 1점 추가
```

**의미:**
- 가격이 과매도 구간에 도달 (통계적으로 낮은 가격)
- 하단 밴드는 "지지선" 역할
- 반등 가능성 높음

**실전 예시:**
```
현재 가격: 42,000,000 KRW
볼린저 하단: 41,800,000 KRW
저가: 41,750,000 KRW

판단: 저가(41,750,000) < 하단(41,800,000)
결과: ✅ 1점 획득
```

---

#### 조건 2: RSI 과매도 (1점)

**측정 방법:**
- RSI(Relative Strength Index) 지표가 35 미만인지 확인

**계산 공식:**
```
RSI = 100 - (100 / (1 + RS))
RS = 평균 상승폭 / 평균 하락폭 (14일 기준)

조건:
RSI < 35  →  1점 획득
```

**점수 부여 조건:**
```python
if latest['rsi'] < 35:
    score += 1  # 1점 추가
```

**의미:**
- RSI는 매수/매도 압력을 측정 (0-100 범위)
- 35 미만: 매도 압력 과도, 과매도 상태
- 30 이하: 전통적인 과매도 기준
- 35 기준 사용: Ver2/Ver3는 조금 더 일찍 진입

**RSI 해석:**
- **70 이상:** 과매수 (매도 고려)
- **50:** 중립
- **35 미만:** 과매도 (매수 고려) ← Ver3 기준
- **30 미만:** 극심한 과매도

**실전 예시:**
```
14일간 평균 상승폭: 500,000 KRW
14일간 평균 하락폭: 1,200,000 KRW

RS = 500,000 / 1,200,000 = 0.417
RSI = 100 - (100 / (1 + 0.417)) = 29.4

판단: RSI(29.4) < 35
결과: ✅ 1점 획득
```

---

#### 조건 3: 스토캐스틱 골든크로스 (2점)

**측정 방법:**
- Stochastic RSI의 %K선이 %D선을 상향 돌파했는지 확인
- 돌파 시점에 둘 다 20 미만이어야 함

**계산 공식:**
```
1. RSI(14) 계산
2. Stochastic RSI 계산:
   %K = (RSI - RSI_min(14)) / (RSI_max(14) - RSI_min(14)) × 100
   %D = %K의 3일 이동평균

조건:
1) 이전 봉: %K <= %D  (데드크로스 상태)
2) 현재 봉: %K > %D   (골든크로스 발생)
3) %K < 20 AND %D < 20  (과매도 구간)

→ 모두 충족 시 2점 획득
```

**점수 부여 조건:**
```python
# 골든크로스 확인
k_cross_above = (
    previous['stoch_rsi_k'] <= previous['stoch_rsi_d'] and
    latest['stoch_rsi_k'] > latest['stoch_rsi_d']
)

# 과매도 구간 확인
both_below_threshold = (
    latest['stoch_rsi_k'] < 20 and
    latest['stoch_rsi_d'] < 20
)

if k_cross_above and both_below_threshold:
    score += 2  # 2점 추가 (가장 중요한 신호!)
```

**의미:**
- Stochastic RSI는 RSI의 변화율을 측정 (더 민감한 지표)
- 골든크로스: 단기 모멘텀이 상승으로 전환
- 과매도 구간에서의 골든크로스: 강한 반등 신호
- 2점 부여 이유: 가장 신뢰도 높은 진입 신호

**실전 예시:**
```
이전 봉 (4시간 전):
  %K = 18.5
  %D = 19.2
  상태: %K < %D (데드크로스)

현재 봉:
  %K = 19.8
  %D = 19.0
  상태: %K > %D (골든크로스 발생!)

판단:
1. 골든크로스 발생 ✅
2. %K(19.8) < 20 ✅
3. %D(19.0) < 20 ✅

결과: ✅ 2점 획득 (강력한 진입 신호!)
```

---

#### 조건 4: 일봉 상승 체제 (필수 조건, 점수 아님)

**측정 방법:**
- 일봉에서 EMA 50이 EMA 200보다 위에 있는지 확인

**계산 공식:**
```
EMA 50 = 50일 지수 이동평균
EMA 200 = 200일 지수 이동평균

조건:
EMA 50 > EMA 200  →  상승 체제 (거래 허용)
EMA 50 <= EMA 200  →  하락 체제 (거래 불가)
```

**의미:**
- Golden Cross 여부 확인 (장기 상승 추세)
- 이 조건을 만족해야 나머지 점수 계산 시작
- 점수 자체는 아니지만 **필수 통과 조건**

**실전 예시:**
```
일봉 데이터:
  EMA 50 = 43,500,000 KRW
  EMA 200 = 40,200,000 KRW

판단: EMA 50(43,500,000) > EMA 200(40,200,000)
결과: ✅ 상승 체제 확인 (거래 가능)

만약 EMA 50 < EMA 200이었다면:
결과: ❌ 하락 체제 (나머지 점수와 무관하게 진입 불가)
```

---

### 진입 점수 종합 예시

#### 예시 1: 완벽한 진입 신호 (4점)

```
일봉 체제: EMA 50(45M) > EMA 200(42M)  →  상승 체제 ✅

4시간봉:
1. 볼린저 밴드:
   - 저가: 44,100,000 KRW
   - 하단: 44,200,000 KRW
   - 저가 < 하단  →  1점 ✅

2. RSI:
   - RSI = 32.5
   - 32.5 < 35  →  1점 ✅

3. 스토캐스틱:
   - 이전: K=17.2, D=18.5 (K < D)
   - 현재: K=18.9, D=18.1 (K > D)
   - 골든크로스 발생 + 둘 다 20 미만  →  2점 ✅

총점: 4/4점
판단: 즉시 매수 (매우 강한 신호)
```

#### 예시 2: 강한 진입 신호 (3점)

```
일봉 체제: 상승 체제 ✅

4시간봉:
1. 볼린저 밴드: 터치 안 함  →  0점 ❌
2. RSI: 34.2 < 35  →  1점 ✅
3. 스토캐스틱: 골든크로스 발생  →  2점 ✅

총점: 3/4점
판단: 매수 (강한 신호, 충분히 진입 가능)
```

#### 예시 3: 최소 진입 신호 (2점)

```
일봉 체제: 상승 체제 ✅

4시간봉:
1. 볼린저 밴드: 터치함  →  1점 ✅
2. RSI: 36.8 > 35  →  0점 ❌
3. 스토캐스틱: 골든크로스 없음, K > 20  →  0점 ❌
   BUT, 일봉 상승 체제 보너스  →  1점 ✅

총점: 2/4점
판단: 매수 가능 (최소 조건 충족)
```

#### 예시 4: 진입 불가 (1점)

```
일봉 체제: 상승 체제 ✅

4시간봉:
1. 볼린저 밴드: 터치함  →  1점 ✅
2. RSI: 38.5 > 35  →  0점 ❌
3. 스토캐스틱: 조건 불충족  →  0점 ❌

총점: 1/4점
판단: 매수 불가 (최소 2점 필요)
```

#### 예시 5: 하락 체제 (진입 불가)

```
일봉 체제: EMA 50 < EMA 200  →  하락 체제 ❌

4시간봉:
1. 볼린저 밴드: 1점
2. RSI: 1점
3. 스토캐스틱: 2점

총점: 4/4점이지만...
판단: 매수 불가 (일봉 체제 필터 통과 실패)
```

---

### 진입 조건 요약

**필수 조건:**
- ✅ 일봉 상승 체제 (EMA 50 > EMA 200)

**진입 점수 조건:**
- ✅ **2점 이상:** 진입 가능
- ✅ **3점 이상:** 강력한 진입 신호 (권장)
- ✅ **4점:** 완벽한 진입 신호 (최우선)

**포트폴리오 제한:**
- 최대 2개 포지션
- 동시 진입 신호 시 점수 높은 코인 우선

---

## 청산 점수 계산 (Exit Scoring)

### 점수 구성 (총 3점)

청산은 진입보다 단순합니다. **2점 이상**이면 즉시 청산합니다.

---

#### 조건 1: 샹들리에 엑시트 (1점)

**측정 방법:**
- ATR(Average True Range) 기반 추적 손절
- 최근 최고가에서 ATR × 3배를 뺀 값이 현재가보다 높으면 청산

**계산 공식:**
```
샹들리에 라인 = 최근 최고가 - (ATR × 3.0)

조건:
현재가 < 샹들리에 라인  →  1점 획득 (추세 전환)
```

**점수 부여 조건:**
```python
chandelier_stop = highest_high - (atr × 3.0)

if current_price < chandelier_stop:
    exit_score += 1  # 추세 약화, 청산 고려
```

**의미:**
- ATR은 변동성을 측정 (평균 가격 변동폭)
- 샹들리에 엑시트는 추세 추종형 손절
- 가격이 라인 아래로 떨어지면 상승 추세 종료
- 3배 곱셈: 과도한 손절 방지 (변동성 고려)

**실전 예시:**
```
포지션 진입 후 최고가: 46,000,000 KRW
현재 ATR: 800,000 KRW
샹들리에 라인: 46,000,000 - (800,000 × 3) = 43,600,000 KRW

현재가: 43,400,000 KRW

판단: 현재가(43,400,000) < 샹들리에 라인(43,600,000)
결과: ✅ 1점 획득 (추세 전환, 청산 신호)
```

**추적 손절 예시:**
```
진입가: 42,000,000 KRW
ATR: 800,000 KRW

봉 1: 최고가 43,000,000  →  샹들리에: 40,600,000 (손절선 상승)
봉 2: 최고가 44,500,000  →  샹들리에: 42,100,000 (손절선 상승)
봉 3: 최고가 46,000,000  →  샹들리에: 43,600,000 (손절선 상승)
봉 4: 현재가 43,400,000  →  샹들리에 라인 돌파! 청산!

최종 수익: +1,400,000 KRW (3.3% 수익)
```

---

#### 조건 2: 수익 실현 타겟 (1점)

**측정 방법:**
- 볼린저 밴드 중간선(TP1) 또는 상단선(TP2) 도달 확인

**계산 공식:**
```
TP1 (First Target) = 볼린저 밴드 중간선 (MA 20)
TP2 (Second Target) = 볼린저 밴드 상단선 (MA 20 + 2×StdDev)

조건:
현재가 >= TP1  →  50% 청산 (1점)
현재가 >= TP2  →  100% 청산 (추가 1점)
```

**점수 부여 조건:**
```python
# TP1 도달 (중간선)
if current_price >= bb_middle:
    exit_score += 1  # 50% 청산
    position_size = position_size * 0.5

# TP2 도달 (상단선)
if current_price >= bb_upper:
    exit_score += 1  # 나머지 100% 청산
```

**의미:**
- 볼린저 밴드는 통계적 가격 범위
- 중간선: 평균 회귀 지점 (일부 수익 실현)
- 상단선: 과매수 구간 (전체 청산)
- 분할 청산으로 리스크 감소

**실전 예시 1: TP1 도달**
```
진입가: 42,000,000 KRW
포지션: 0.001 BTC

현재 상황:
- 현재가: 43,500,000 KRW
- 볼린저 중간선: 43,200,000 KRW
- 볼린저 상단선: 45,800,000 KRW

판단: 현재가(43,500,000) >= 중간선(43,200,000)
행동: TP1 도달! 50% 청산

청산: 0.0005 BTC @ 43,500,000 KRW
수익: (43,500,000 - 42,000,000) × 0.0005 = +750,000 KRW
남은 포지션: 0.0005 BTC (상단선까지 보유)
```

**실전 예시 2: TP2 도달**
```
(TP1 청산 후)
남은 포지션: 0.0005 BTC
진입가: 42,000,000 KRW

현재 상황:
- 현재가: 46,200,000 KRW
- 볼린저 상단선: 45,800,000 KRW

판단: 현재가(46,200,000) >= 상단선(45,800,000)
행동: TP2 도달! 나머지 100% 청산

청산: 0.0005 BTC @ 46,200,000 KRW
수익: (46,200,000 - 42,000,000) × 0.0005 = +2,100,000 KRW

총 수익: 750,000 + 2,100,000 = +2,850,000 KRW (6.8%)
```

---

#### 조건 3: EMA 데드크로스 (1점)

**측정 방법:**
- 일봉에서 EMA 50이 EMA 200 아래로 떨어졌는지 확인

**계산 공식:**
```
조건:
EMA 50 < EMA 200  →  1점 획득 (장기 하락 추세 전환)
```

**점수 부여 조건:**
```python
if daily_ema_50 < daily_ema_200:
    exit_score += 1  # 체제 전환, 청산 필요
```

**의미:**
- Death Cross 발생 (장기 하락 추세 시작)
- 진입 시 Golden Cross였으나 이제 반대
- 체제가 바뀌었으므로 보유 포지션 청산
- 향후 진입도 불가 (일봉 필터 통과 실패)

**실전 예시:**
```
포지션 진입 시 (2주 전):
  EMA 50: 43,500,000 KRW
  EMA 200: 40,200,000 KRW
  상태: Golden Cross (상승 체제)

현재:
  EMA 50: 42,800,000 KRW
  EMA 200: 43,100,000 KRW
  상태: Death Cross 발생! (하락 체제)

판단: EMA 50 < EMA 200
행동: ✅ 1점 획득, 즉시 청산 (체제 전환)
```

---

### 청산 점수 종합 예시

#### 예시 1: 즉시 청산 (3점)

```
포지션: BTC 0.001개 @ 42,000,000 KRW

현재 상황:
1. 샹들리에 엑시트:
   - 최고가: 46,000,000
   - ATR: 800,000
   - 라인: 43,600,000
   - 현재가: 43,400,000 < 43,600,000  →  1점 ✅

2. 수익 목표:
   - 현재가: 43,400,000
   - TP1 (중간선): 43,200,000
   - 현재가 >= TP1  →  1점 ✅

3. EMA 데드크로스:
   - EMA 50: 42,800,000
   - EMA 200: 43,100,000
   - EMA 50 < EMA 200  →  1점 ✅

총 청산 점수: 3/3점
판단: 즉시 전체 청산 (다중 청산 신호)
```

#### 예시 2: 부분 청산 (2점)

```
포지션: ETH 0.05개 @ 3,200,000 KRW

현재 상황:
1. 샹들리에 엑시트:
   - 현재가 > 샹들리에 라인  →  0점 ❌

2. 수익 목표:
   - 현재가: 3,350,000
   - TP1: 3,300,000  →  1점 ✅ (50% 청산)
   - TP2: 3,500,000  →  도달 안 함

3. EMA 데드크로스:
   - EMA 50 > EMA 200  →  0점 ❌ (여전히 상승 체제)

총 청산 점수: 1/3점
판단: TP1 도달, 50%만 청산 (나머지는 TP2까지 보유)
```

#### 예시 3: 손절 (2점)

```
포지션: XRP 100개 @ 800 KRW

현재 상황:
1. 샹들리에 엑시트:
   - 현재가: 750 KRW
   - 샹들리에 라인: 770 KRW
   - 750 < 770  →  1점 ✅

2. 수익 목표:
   - TP1 도달 안 함  →  0점 ❌

3. EMA 데드크로스:
   - EMA 50: 790
   - EMA 200: 810
   - EMA 50 < EMA 200  →  1점 ✅

총 청산 점수: 2/3점
판단: 즉시 청산 (손절 -6.25%)
```

---

### 청산 조건 요약

**즉시 청산:**
- ✅ **2점 이상:** 전체 또는 부분 청산
- ✅ **3점:** 강력한 청산 신호 (즉시 전체 청산)

**부분 청산:**
- ✅ TP1 도달: 50% 청산, 나머지는 TP2까지 보유
- ✅ TP2 도달: 나머지 100% 청산

**손절:**
- ✅ 샹들리에 엑시트: ATR × 3.0 (약 6-8% 손실)
- ✅ 체제 전환: Death Cross 발생 시 즉시 청산

---

## 포트폴리오 관리

### 진입 우선순위

Ver3는 여러 코인이 동시에 진입 신호를 보낼 때 **점수가 높은 코인부터 진입**합니다.

#### 우선순위 결정 규칙

```
1. 진입 점수 비교 (높을수록 우선)
   4점 > 3점 > 2점

2. 동점일 경우 coin_rank 비교
   BTC(4) > ETH(3) > XRP(2) > SOL(1)

3. 포트폴리오 제한 적용
   max_positions 초과 시 낮은 점수 코인 제외
```

#### 실전 예시 1: 동시 진입 신호

```
시나리오:
- 포트폴리오: 0/2 포지션 (빈 상태)
- 동시 진입 신호 발생

코인별 점수:
- BTC: 3/4점 (강한 신호)
- ETH: 4/4점 (완벽한 신호)
- XRP: 2/4점 (최소 신호)

우선순위 정렬:
1. ETH (4점) ← 최우선
2. BTC (3점)
3. XRP (2점)

포트폴리오 결정:
- max_positions = 2
- 진입 가능: 2개

실행:
✅ ETH 진입 (1순위)
✅ BTC 진입 (2순위)
⛔ XRP 대기 (포트폴리오 제한)

결과: ETH와 BTC 포지션 오픈
```

#### 실전 예시 2: 동점 처리

```
시나리오:
- 포트폴리오: 1/2 포지션 (BTC 보유 중)
- 신호 발생

코인별 점수:
- ETH: 3/4점
- XRP: 3/4점 (동점!)
- SOL: 2/4점

우선순위 정렬 (동점 시 coin_rank 사용):
1. ETH (3점, rank=3)
2. XRP (3점, rank=2) ← rank 낮음
3. SOL (2점)

포트폴리오 결정:
- 현재 1개 보유
- 진입 가능: 1개만

실행:
✅ ETH 진입 (동점이지만 coin_rank 높음)
⛔ XRP 대기
⛔ SOL 대기

결과: BTC + ETH 포지션 (2/2 가득 참)
```

#### 실전 예시 3: 포트폴리오 포화 상태

```
시나리오:
- 포트폴리오: 2/2 포지션 (BTC, ETH 보유)
- 신호 발생

코인별 점수:
- XRP: 4/4점 (완벽한 신호!)
- SOL: 3/4점

포트폴리오 결정:
- max_positions = 2 (이미 가득 참)
- 진입 가능: 0개

실행:
⛔ XRP 진입 불가 (포트폴리오 제한)
⛔ SOL 진입 불가

로그:
"⛔ Portfolio limit reached (2 positions), skipping XRP entry"

대안:
1. 기존 포지션 중 하나 청산 대기
2. 청산 후 XRP 자동 진입 (다음 사이클)
```

---

### 리스크 관리

#### 포트폴리오 레벨 리스크

**최대 포지션 수:**
```python
PORTFOLIO_CONFIG = {
    'max_positions': 2,  # 동시 최대 2개
}
```

**의미:**
- 2개 코인에만 집중 투자
- 과도한 분산 방지
- 집중력 있는 포트폴리오 관리

**리스크 계산:**
```
코인당 리스크: 2% (RISK_CONFIG['risk_per_trade_pct'])
최대 포지션: 2개
총 포트폴리오 리스크: 2% × 2 = 4%

max_portfolio_risk_pct: 6.0% (여유분 2%)
```

#### 포지션당 금액 및 리스크

**기본 설정:**
```python
POSITION_SIZING_CONFIG = {
    'base_amount_krw': 50000,  # 코인당 5만원
}

TRADING_CONFIG = {
    'trade_amount_krw': 50000,
}
```

**실제 투입 자금:**
```
코인 1개 진입: 50,000 KRW
최대 2개 진입: 100,000 KRW

권장 총 자금: 200,000 KRW 이상
(안전 마진 2배)
```

**손실 제한:**
```python
RISK_CONFIG = {
    'max_daily_loss_pct': 3.0,       # 일일 3% 손실 제한
    'max_consecutive_losses': 3,      # 연속 3회 손실 제한
    'max_daily_trades': 5,            # 일일 5회 거래 제한
}
```

**발동 예시:**
```
포트폴리오: 1,000,000 KRW

시나리오 1: 일일 손실 3% 초과
- 당일 손실: 32,000 KRW (3.2%)
- 발동: 일일 거래 중단
- 복구: 다음 날 00시

시나리오 2: 연속 손실 3회
- 1회: -10,000 KRW
- 2회: -15,000 KRW
- 3회: -12,000 KRW
- 발동: 1시간 거래 중단
- 복구: 1시간 후 또는 1회 승리

시나리오 3: 일일 거래 5회
- 오전 2회, 오후 3회
- 발동: 당일 신규 진입 중단
- 복구: 다음 날 00시
```

---

### 분산 효과

#### 왜 멀티코인 포트폴리오인가?

**단일 코인 (Ver2):**
```
BTC만 거래:
- BTC 10% 상승 → 포트폴리오 +10%
- BTC 10% 하락 → 포트폴리오 -10%
- 변동성: 매우 높음
```

**멀티코인 (Ver3):**
```
BTC + ETH 동시 거래 (각 50% 비중):
- BTC +10%, ETH +5% → 포트폴리오 +7.5%
- BTC -10%, ETH +5% → 포트폴리오 -2.5%
- 변동성: 완화됨
```

#### 상관관계 고려

**높은 상관관계 (비추천):**
```
BTC + ETH
- 상관계수: 0.85 (매우 높음)
- BTC 상승 시 ETH도 상승
- BTC 하락 시 ETH도 하락
- 분산 효과: 약함
```

**낮은 상관관계 (권장):**
```
BTC + XRP
- 상관계수: 0.45 (중간)
- BTC 상승해도 XRP 독립적
- BTC 하락 시 XRP는 상승 가능
- 분산 효과: 강함
```

#### 권장 코인 조합

**안정형 (낮은 변동성):**
```
default_coins: ['BTC']
max_positions: 1
→ BTC만 집중, 가장 안정적
```

**균형형 (중간 변동성):**
```
default_coins: ['BTC', 'ETH', 'XRP']
max_positions: 2
→ 2개 선택, 분산 효과와 집중력 균형
```

**공격형 (높은 변동성):**
```
default_coins: ['ETH', 'XRP', 'SOL']
max_positions: 2
→ 알트코인 중심, 고위험 고수익
```

---

## 실전 시나리오

### 시나리오 1: 완벽한 BTC 진입

**시장 상황:**
```
날짜: 2025-10-08 14:00
포트폴리오: 0/2 (빈 상태)
```

**BTC 분석 (일봉):**
```
체제 필터:
- EMA 50: 45,200,000 KRW
- EMA 200: 42,800,000 KRW
- 판단: EMA 50 > EMA 200 ✅ 상승 체제
```

**BTC 분석 (4시간봉):**
```
진입 점수:
1. 볼린저 밴드:
   - 저가: 44,100,000 KRW
   - 하단선: 44,200,000 KRW
   - 44,100,000 < 44,200,000 → 1점 ✅

2. RSI:
   - 현재 RSI: 32.8
   - 32.8 < 35 → 1점 ✅

3. 스토캐스틱:
   - 이전: K=16.5, D=18.2 (K < D)
   - 현재: K=19.3, D=17.8 (K > D)
   - 골든크로스 + 둘 다 < 20 → 2점 ✅

총점: 4/4점 (완벽한 신호!)
```

**포트폴리오 결정:**
```
진입 가능 여부:
- 현재 포지션: 0/2
- max_positions: 2
- 슬롯 여유: 2개

판단: ✅ BTC 진입 확정
```

**주문 실행:**
```
매수 주문:
- 코인: BTC
- 금액: 50,000 KRW
- 가격: 44,150,000 KRW
- 수량: 0.001133 BTC

손절 설정:
- ATR: 800,000 KRW
- 최고가: 44,150,000 KRW
- 샹들리에: 44,150,000 - (800,000 × 3) = 41,750,000 KRW
- 손절가: 41,750,000 KRW (-5.4%)

목표가:
- TP1 (중간선): 45,800,000 KRW (+3.7%, 50% 청산)
- TP2 (상단선): 47,400,000 KRW (+7.4%, 100% 청산)
```

**결과 (24시간 후):**
```
BTC 가격 추이:
- 14:00 진입: 44,150,000
- 18:00 상승: 45,900,000 (TP1 도달!)
  → 50% 청산 @ 45,900,000 (+3.9% 수익, +2,000 KRW)
- 익일 10:00 상승: 47,600,000 (TP2 도달!)
  → 나머지 50% 청산 @ 47,600,000 (+7.8% 수익, +1,960 KRW)

총 수익: +3,960 KRW (7.9% 수익)
포트폴리오: 1,003,960 KRW
```

---

### 시나리오 2: 동시 진입 신호 (우선순위 처리)

**시장 상황:**
```
날짜: 2025-10-09 10:00
포트폴리오: 0/2 (빈 상태)
```

**3개 코인 모두 진입 신호:**
```
BTC:
- 체제: 상승 ✅
- 점수: 3/4 (BB터치 + RSI과매도 + 일봉상승)
- 신호 강도: 0.75

ETH:
- 체제: 상승 ✅
- 점수: 4/4 (모든 조건 충족)
- 신호 강도: 1.00

XRP:
- 체제: 상승 ✅
- 점수: 2/4 (BB터치 + 일봉상승)
- 신호 강도: 0.50
```

**포트폴리오 우선순위 결정:**
```
진입 점수 정렬:
1. ETH: 4/4점 (최우선)
2. BTC: 3/4점
3. XRP: 2/4점

포트폴리오 제한:
- max_positions: 2
- 현재 포지션: 0
- 진입 가능: 2개

선택:
✅ ETH 진입 (1순위, 4점)
✅ BTC 진입 (2순위, 3점)
⛔ XRP 대기 (포트폴리오 제한)
```

**주문 실행:**
```
ETH 매수:
- 가격: 3,250,000 KRW
- 금액: 50,000 KRW
- 수량: 0.0154 ETH

BTC 매수:
- 가격: 45,300,000 KRW
- 금액: 50,000 KRW
- 수량: 0.001104 BTC

포트폴리오 상태: 2/2 (포화)
```

**결과 (48시간 후):**
```
ETH:
- 진입: 3,250,000
- TP1 도달: 3,380,000 (+4.0%)
  → 50% 청산, +3,000 KRW
- TP2 도달: 3,510,000 (+8.0%)
  → 100% 청산, +2,000 KRW
- 총 수익: +5,000 KRW

BTC:
- 진입: 45,300,000
- 샹들리에 손절: 44,100,000 (-2.6%)
  → 전체 청산, -1,300 KRW
- 손실: -1,300 KRW

포트폴리오 총손익:
ETH +5,000 + BTC -1,300 = +3,700 KRW (3.7% 수익)

분산 효과:
- BTC 손실을 ETH 수익이 상쇄
- 단일 코인이었다면 BTC -2.6% 손실
- 멀티코인으로 +3.7% 수익 달성!
```

---

## 피라미딩 전략 이론 (Pyramiding Strategy Theory)

### 피라미딩이란?

피라미딩(Pyramiding)은 **수익이 나고 있는 포지션에 추가로 진입하여 수익을 극대화하는 포지션 관리 기법**입니다.

#### 기본 개념

**전통적 방식 (단일 진입):**
```
BTC 진입: 100,000,000 KRW
투자금: 50,000 KRW
수량: 0.0005 BTC

가격이 110,000,000 KRW로 상승:
수익: (110,000,000 - 100,000,000) × 0.0005 = +5,000 KRW (10% 수익)
```

**피라미딩 방식 (다중 진입):**
```
1차 진입: 100,000,000 KRW, 50,000 KRW → 0.0005 BTC
2차 진입: 102,000,000 KRW, 25,000 KRW → 0.000245 BTC
3차 진입: 104,040,000 KRW, 12,500 KRW → 0.00012 BTC

총 투자: 87,500 KRW
총 수량: 0.000865 BTC
평균 진입가: 약 101,156,000 KRW

가격이 110,000,000 KRW로 상승:
수익: (110,000,000 - 101,156,000) × 0.000865 = +7,650 KRW (8.7% 수익)

→ 단일 진입 대비 +52% 더 많은 수익!
```

#### 왜 피라미딩을 사용하는가?

**장점:**
1. **추세 활용 극대화**
   - 강한 상승 추세에서 더 큰 수익
   - 성공 확률 높은 포지션에 집중 투자

2. **심리적 안정감**
   - 이미 수익 나는 상태에서 추가 진입
   - 손실 구간에서 추가 진입하는 마틴게일과 정반대

3. **리스크 관리**
   - 첫 진입이 성공한 후에만 추가
   - 추가 진입은 더 작은 크기 (100% → 50% → 25%)

**단점:**
1. **역추세 시 손실 증가**
   - 추가 진입 후 가격 반전 시 평균 진입가 상승
   - 손실 구간 진입 가능성

2. **자금 소진 빠름**
   - 여러 번 진입하므로 총 투자금 증가
   - 동시에 다른 코인 진입 기회 감소

---

### Ver3 피라미딩 메커니즘

#### 진입 조건 (6가지 필터)

Ver3는 다음 **6가지 조건을 모두 만족할 때만** 추가 진입합니다:

**1. 피라미딩 활성화**
```python
PYRAMIDING_CONFIG['enabled'] = True
```
설정에서 피라미딩이 켜져 있어야 함

**2. 진입 횟수 제한**
```python
현재 진입 횟수 < max_entries_per_coin (기본: 3)
```
예: 이미 2회 진입했으면 3회까지만 가능

**3. 진입 점수 충족**
```python
entry_score >= min_score_for_pyramid (기본: 3)
```
추가 진입은 첫 진입보다 높은 점수 필요
- 첫 진입: 2점 이상
- 추가 진입: 3점 이상 (더 강한 신호)

**4. 신호 강도 충족**
```python
signal_strength >= min_signal_strength_for_pyramid (기본: 0.7)
```
신호 강도가 70% 이상이어야 추가 진입

**5. 가격 상승 확인**
```python
price_increase_pct >= min_price_increase_pct (기본: 2.0%)
```
마지막 진입가 대비 최소 2% 상승 필요

**계산:**
```
마지막 진입가: 100,000,000 KRW
현재 가격: 102,000,000 KRW
상승률: (102,000,000 - 100,000,000) / 100,000,000 × 100 = 2.0%

2.0% >= 2.0% → 조건 충족 ✅
```

**6. 시장 체제 확인**
```python
market_regime in allow_pyramid_in_regime
(기본: ['bullish', 'neutral'])
```
bullish 또는 neutral 체제에서만 추가
- bullish: 상승 추세 → 추가 진입 허용
- neutral: 횡보 → 추가 진입 허용
- bearish: 하락 추세 → 추가 진입 금지

---

### 포지션 크기 전략

#### 감소하는 포지션 크기 (Decreasing Size)

Ver3는 **피라미드 모양**처럼 점점 작아지는 포지션 크기를 사용합니다:

```
        ▲ 가격
        │
  25%   ├─────┐  3차 진입 (12,500원)
        │     │
  50%   ├─────┴────┐  2차 진입 (25,000원)
        │          │
 100%   ├──────────┴─────┐  1차 진입 (50,000원)
        │                │
        └────────────────┴──────► 시간
```

**크기 비율:**
```python
position_size_multiplier = [1.0, 0.5, 0.25]
```

**실제 계산:**
```
base_amount_krw = 50,000 KRW

1차 진입: 50,000 × 1.0 = 50,000 KRW (100%)
2차 진입: 50,000 × 0.5 = 25,000 KRW (50%)
3차 진입: 50,000 × 0.25 = 12,500 KRW (25%)

총 투자: 87,500 KRW (175% of base)
```

#### 왜 감소하는 크기인가?

**이유 1: 리스크 관리**
- 가격이 높아질수록 반전 리스크 증가
- 작은 크기로 추가하여 평균 진입가 상승 억제

**이유 2: 자금 효율**
- 첫 진입이 가장 좋은 가격
- 대부분의 자금을 낮은 가격에 투입

**이유 3: 심리적 안정**
- 반전 시에도 대부분은 낮은 진입가
- 평균 진입가가 크게 상승하지 않음

**계산 예시:**
```
시나리오 1: 감소 크기 [1.0, 0.5, 0.25]
1차: 100,000,000원 × 0.0005 = 50,000원
2차: 102,000,000원 × 0.000245 = 24,990원
3차: 104,040,000원 × 0.00012 = 12,485원
평균 진입가: 100,909,000원 (0.9% 상승)

시나리오 2: 균등 크기 [1.0, 1.0, 1.0] (비권장)
1차: 100,000,000원 × 0.0005 = 50,000원
2차: 102,000,000원 × 0.0005 = 51,000원
3차: 104,040,000원 × 0.0005 = 52,020원
평균 진입가: 102,013,000원 (2.0% 상승)

→ 감소 크기가 평균 진입가를 1.1% 낮게 유지!
```

---

### 평균 진입가 계산

#### 가중 평균 공식

피라미딩 시 **가중 평균 진입가**가 자동으로 계산됩니다:

```
평균 진입가 = (진입가1 × 수량1 + 진입가2 × 수량2 + ...) / 총 수량
```

#### 실전 예시

**BTC 피라미딩:**
```
1차 진입:
- 가격: 100,000,000 KRW
- 투자: 50,000 KRW
- 수량: 0.0005 BTC

2차 진입 (2% 상승):
- 가격: 102,000,000 KRW
- 투자: 25,000 KRW
- 수량: 0.000245 BTC

평균 진입가 계산:
= (100,000,000 × 0.0005 + 102,000,000 × 0.000245) / (0.0005 + 0.000245)
= (50,000 + 24,990) / 0.000745
= 74,990 / 0.000745
= 100,657,000 KRW

3차 진입 (4.04% 상승):
- 가격: 104,040,000 KRW
- 투자: 12,500 KRW
- 수량: 0.00012 BTC

최종 평균 진입가:
= (100,657,000 × 0.000745 + 104,040,000 × 0.00012) / (0.000745 + 0.00012)
= (74,989 + 12,485) / 0.000865
= 87,474 / 0.000865
= 101,156,000 KRW

→ 첫 진입 대비 1.16% 높아짐
```

#### 평균 진입가의 중요성

**손익 계산:**
```
평균 진입가: 101,156,000 KRW
총 수량: 0.000865 BTC

시나리오 1: 110,000,000 KRW 도달
수익 = (110,000,000 - 101,156,000) × 0.000865 = +7,650 KRW

시나리오 2: 100,000,000 KRW 반전
손실 = (100,000,000 - 101,156,000) × 0.000865 = -1,000 KRW

→ 첫 진입가보다는 높지만 전체적으로 여전히 수익 가능
```

---

### 피라미딩 vs 마틴게일

#### 두 전략의 차이

**피라미딩 (Pyramiding):**
```
✅ 수익 나는 포지션에 추가
✅ 추세를 따라가며 수익 극대화
✅ 작아지는 포지션 크기

예시:
1차: 100M 진입 → +2% 수익
2차: 102M 추가 → +4% 수익
3차: 106M 추가 → +6% 수익
```

**마틴게일 (Martingale, 비권장!):**
```
❌ 손실 나는 포지션에 추가
❌ 평균 진입가를 낮추려는 시도
❌ 커지는 포지션 크기

예시:
1차: 100M 진입 → -2% 손실
2차: 98M 추가 (2배) → -4% 손실
3차: 96M 추가 (4배) → -8% 손실
→ 파산 위험!
```

#### 왜 피라미딩을 사용하는가?

**피라미딩의 안전성:**
1. **이미 수익 중**
   - 첫 진입이 성공한 후에만 추가
   - 심리적으로 안정

2. **추세 확인**
   - 가격 상승 = 추세 지속 신호
   - 확률적으로 유리

3. **리스크 제한**
   - 작은 크기로 추가
   - 반전 시에도 손실 최소화

**마틴게일의 위험성:**
1. **손실 확대**
   - 하락 추세에서 계속 추가
   - 평균 진입가 낮아지지만 총 손실 증가

2. **자금 소진**
   - 2배, 4배, 8배로 증가
   - 연속 하락 시 파산

3. **심리적 압박**
   - 손실 중 추가 매수는 고통
   - 감정적 판단 유도

---

### 피라미딩 시 리스크 관리

#### 손절 관리 전략

**방법 1: 추적 손절 (Trailing Stop)**
```
1차 진입: 100M, 손절 97M (3% 손절)

2차 진입: 102M 추가
→ 1차 손절을 100M(본전)으로 이동
→ 2차 손절은 99M (3% 손절)

3차 진입: 104M 추가
→ 1차 손절: 100M(본전) 유지
→ 2차 손절을 102M(본전)으로 이동
→ 3차 손절은 101M (3% 손절)

효과: 최악의 경우에도 본전 또는 소액 손실
```

**방법 2: 샹들리에 엑시트 (Ver3 기본)**
```
진입 시 ATR 계산: 800,000 KRW

최고가 업데이트 시 손절선 상승:
1차 진입: 100M → 손절 97.6M (100M - 3×ATR)
가격 상승: 104M → 손절 101.6M (104M - 3×ATR)
가격 상승: 108M → 손절 105.6M (108M - 3×ATR)

추세 전환 시: 가격 105M < 손절 105.6M → 전체 청산

효과: 큰 수익 확보 + 추세 반전 시 빠른 청산
```

#### 포지션 분할 청산

**TP1과 TP2 활용:**
```
진입 완료:
- 평균 진입가: 101,156,000 KRW
- 총 수량: 0.000865 BTC

TP1 (볼린저 중간선): 106,000,000 KRW
→ 50% 청산: 0.0004325 BTC 매도
→ 수익 확보: (106,000,000 - 101,156,000) × 0.0004325 = +2,095 KRW
→ 남은 포지션: 0.0004325 BTC (무리스크 상태)

TP2 (볼린저 상단선): 112,000,000 KRW
→ 나머지 100% 청산: 0.0004325 BTC 매도
→ 추가 수익: (112,000,000 - 101,156,000) × 0.0004325 = +4,690 KRW

총 수익: 2,095 + 4,690 = +6,785 KRW (7.8% 수익)
```

#### 최대 진입 횟수 제한

**왜 3회로 제한하는가?**

1. **자금 관리**
   ```
   1회: 50,000원 (총 50,000원)
   2회: 25,000원 (총 75,000원)
   3회: 12,500원 (총 87,500원)
   4회: 6,250원 (총 93,750원) ← 거의 차이 없음
   ```

2. **수익률 체감**
   ```
   3회까지: 평균 진입가 1.16% 상승
   4회까지: 평균 진입가 1.35% 상승

   → 추가 이익 0.19%포인트 (미미함)
   ```

3. **리스크 증가**
   - 높은 가격에서 계속 추가
   - 반전 가능성 증가

**권장 설정:**
- 보수적: `max_entries_per_coin = 2` (1차 + 1회 추가)
- 균형: `max_entries_per_coin = 3` (1차 + 2회 추가, 기본)
- 공격적: `max_entries_per_coin = 4` (비권장)

---

### 실전 시나리오: 피라미딩

#### 시나리오 1: 완벽한 피라미딩 (3회 진입)

**초기 상황:**
```
날짜: 2025-10-10 10:00
포트폴리오: 1/2 (ETH 보유 중)
BTC 분석:
- 일봉 체제: 상승 ✅
- 4H 진입 점수: 4/4
- 신호 강도: 1.00
```

**1차 진입:**
```
시간: 10:00
가격: 100,000,000 KRW
투자: 50,000 KRW
수량: 0.0005 BTC
손절: 97,600,000 KRW (샹들리에)
```

**2차 진입 (4시간 후):**
```
시간: 14:00
현재 가격: 102,500,000 KRW
가격 상승: 2.5% (조건 충족 ✅)
BTC 분석:
- 일봉 체제: 상승 ✅
- 4H 진입 점수: 3/4 (조건 충족 ✅)
- 신호 강도: 0.80 (조건 충족 ✅)

피라미딩 조건 체크:
1. 피라미딩 활성화: True ✅
2. 진입 횟수: 1 < 3 ✅
3. 진입 점수: 3 >= 3 ✅
4. 신호 강도: 0.80 >= 0.7 ✅
5. 가격 상승: 2.5% >= 2.0% ✅
6. 시장 체제: bullish in ['bullish', 'neutral'] ✅

→ 모든 조건 충족! 2차 진입 실행

2차 진입:
투자: 25,000 KRW (50% 크기)
수량: 0.000244 BTC
총 수량: 0.000744 BTC
평균 진입가: 100,673,000 KRW
```

**3차 진입 (4시간 후):**
```
시간: 18:00
현재 가격: 105,000,000 KRW
가격 상승: 2.44% (조건 충족 ✅)
BTC 분석:
- 진입 점수: 3/4 ✅
- 신호 강도: 0.75 ✅

피라미딩 조건: 모두 충족 ✅

3차 진입:
투자: 12,500 KRW (25% 크기)
수량: 0.000119 BTC
총 수량: 0.000863 BTC
평균 진입가: 101,217,000 KRW
총 투자: 87,500 KRW
```

**청산 (익일):**
```
시간: 다음 날 14:00
현재 가격: 112,000,000 KRW

TP2 (볼린저 상단) 도달!
청산: 0.000863 BTC @ 112,000,000 KRW
수익: (112,000,000 - 101,217,000) × 0.000863 = +9,305 KRW
수익률: 10.6%

비교: 단일 진입 시
수익: (112,000,000 - 100,000,000) × 0.0005 = +6,000 KRW
수익률: 12%

→ 피라미딩으로 +3,305 KRW 추가 수익 (+55% 더 많음!)
```

#### 시나리오 2: 피라미딩 후 반전 (손실)

**초기 상황:**
```
ETH 1차 진입:
- 가격: 3,000,000 KRW
- 투자: 50,000 KRW
- 수량: 0.01667 ETH
```

**2차 진입:**
```
가격: 3,100,000 KRW (+3.3%)
투자: 25,000 KRW
수량: 0.00806 ETH
총 수량: 0.02473 ETH
평균 진입가: 3,033,000 KRW
```

**가격 반전:**
```
현재 가격: 2,950,000 KRW
샹들리에 라인: 2,960,000 KRW

판단: 2,950,000 < 2,960,000 → 손절 신호!
청산: 0.02473 ETH @ 2,950,000 KRW

손실 계산:
(2,950,000 - 3,033,000) × 0.02473 = -2,052 KRW
손실률: -2.7%

비교: 단일 진입 시
(2,950,000 - 3,000,000) × 0.01667 = -834 KRW
손실률: -1.7%

→ 피라미딩으로 손실 1.46배 증가
   (하지만 수익 시 1.55배 증가하므로 장기적으로 유리)
```

---

### 피라미딩 최적 상황

#### 언제 피라미딩이 효과적인가?

**최적 상황 1: 강한 추세 시장**
```
특징:
- 일봉 EMA50 > EMA200 (명확한 상승 체제)
- 4H 연속 상승
- 높은 거래량
- ADX > 25 (강한 추세)

예시: 2021년 비트코인 불장
3월: 60M → 4월: 63M (+5%) → 5월: 67M (+12%)
→ 피라미딩으로 수익 극대화 가능
```

**최적 상황 2: 브레이크아웃 후**
```
특징:
- 장기 저항선 돌파
- 높은 거래량 동반
- 진입 점수 4/4

예시: 레지스탕스 돌파
100M 저항 → 101M 돌파 → 105M 상승
→ 돌파 확인 후 피라미딩 효과적
```

**비효과적 상황: 횡보장**
```
특징:
- 일봉 중립 체제
- 가격 반복 등락
- 낮은 ADX (< 20)

예시: 박스권 장세
100M ↔ 102M ↔ 100M ↔ 101M
→ 피라미딩 시 평균 진입가만 올라감
→ 단일 진입이 더 효과적
```

#### Ver3의 자동 필터링

Ver3는 비효과적인 상황을 **자동으로 차단**합니다:

```python
# 횡보장 필터
if market_regime == 'neutral':
    # neutral도 허용하지만...
    # 진입 점수 3점 이상 + 신호 강도 0.7 이상 필요
    # → 명확한 신호만 통과

# 약한 신호 차단
if entry_score < 3 or signal_strength < 0.7:
    # 피라미딩 거부
    return False

# 가격 상승 확인
if price_increase_pct < 2.0:
    # 추세가 약함
    return False
```

---

## 참고사항

### 지표 이해를 위한 추가 자료

**볼린저 밴드:**
- 통계학의 표준편차 개념 활용
- 가격의 95% 확률 범위 표시
- 하단 터치 = 통계적으로 저렴한 가격

**RSI (Relative Strength Index):**
- 1978년 Welles Wilder 개발
- 매수/매도 압력 비율 측정
- 0-100 범위, 50=중립

**Stochastic RSI:**
- RSI의 변화율 측정 (더 민감)
- RSI가 느리다고 느낄 때 사용
- 골든크로스는 강력한 모멘텀 신호

**ATR (Average True Range):**
- 변동성 측정 지표
- 높을수록 가격 변동 큼
- 샹들리에 엑시트에 활용

**EMA (Exponential Moving Average):**
- 최근 가격에 더 큰 가중치
- SMA보다 빠른 반응
- Golden Cross = 장기 상승 신호

### 전략 성공을 위한 핵심

**1. 체제 필터 준수:**
- 일봉 하락 체제에서는 절대 진입 금지
- 아무리 4시간봉 점수가 높아도 체제 우선

**2. 점수 기반 진입:**
- 2점: 최소 조건 (신중히 진입)
- 3점: 권장 진입 (충분한 신호)
- 4점: 적극 진입 (강력한 신호)

**3. 포트폴리오 제한 준수:**
- max_positions 엄수
- 욕심내서 3개 포지션 금지

**4. 손절 엄격히 준수:**
- 샹들리에 라인 돌파 시 즉시 청산
- 감정 배제, 기계적 실행

**5. 분할 청산 활용:**
- TP1에서 50% 청산 (수익 확보)
- 나머지는 TP2까지 보유 (추가 수익)

### 실전 체크리스트

**매일 확인사항:**
- ✅ 포트폴리오 상태 (X/2 포지션)
- ✅ 일일 손익 (3% 손실 제한 확인)
- ✅ 로그 확인 (오류 없는지)

**매주 확인사항:**
- ✅ 승률 및 손익비 계산
- ✅ 진입/청산 점수 분포 분석
- ✅ 설정 조정 필요성 검토

**Dry-run 테스트:**
- 최소 1주일 Dry-run 필수
- 실거래 전 충분한 신호 확인
- 로그에서 점수 계산 검증

---

**Ver3 거래 이론 및 점수 계산 끝**

이론을 이해했다면 이제 실전입니다. Dry-run으로 충분히 테스트하세요! 📚
