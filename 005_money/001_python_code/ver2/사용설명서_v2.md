# 비트코인 멀티 타임프레임 거래 전략 v2.0 사용 설명서

**문서 버전:** 2.0
**최종 업데이트:** 2025-10-03
**개발팀:** Trading Bot Team

---

## 📋 목차

1. [시스템 개요](#1-시스템-개요)
2. [설치 방법](#2-설치-방법)
3. [실행 방법](#3-실행-방법)
4. [GUI 사용법](#4-gui-사용법)
5. [설정 변경 방법](#5-설정-변경-방법)
6. [거래 전략 이해하기](#6-거래-전략-이해하기)
7. [위험 관리 기능](#7-위험-관리-기능)
8. [문제 해결 가이드](#8-문제-해결-가이드)
9. [FAQ](#9-faq)

---

## 1. 시스템 개요

### 1.1 전략 소개

**비트코인 멀티 타임프레임 거래 전략 v2.0**은 안정성에 초점을 맞춘 보수적 추세 추종 시스템입니다.

**핵심 특징:**
- 📊 **멀티 타임프레임 분석**: 일봉으로 큰 흐름 파악, 4시간봉으로 진입/청산
- 🎯 **점수 기반 진입 시스템**: 3가지 지표의 합산 점수로 신뢰도 높은 매수 신호 생성
- 🛡️ **샹들리에 엑시트**: ATR 기반 추적 손절매로 동적 리스크 관리
- 💰 **분할 매매**: 50% 초기 진입, 목표가 달성 시 단계별 청산
- 🔒 **종합 위험 관리**: 연속 손실 제한, 일일 손실 한도, 회로차단기

**전략 분류:**
- 유형: 보수적 추세 추종 (롱 온리)
- 목표 승률: 55-65%
- 리스크-리워드 비율: 비대칭 (1:2.5+ 잠재 수익)
- 권장 투자 기간: 중장기 (최소 6개월 이상)

### 1.2 주요 기능

#### 백테스팅 모드
- Backtrader 프레임워크 기반 정교한 시뮬레이션
- 10개월 이상 과거 데이터 검증
- 상세한 성과 분석 및 리포트

#### GUI 모드
- 5개 탭으로 구성된 직관적 인터페이스
- 실시간 차트 및 지표 시각화
- 신호 히스토리 및 거래 내역 추적
- 시장 체제 및 진입 점수 실시간 모니터링

#### 위험 관리
- 거래당 2% 포트폴리오 리스크 제한
- 연속 5회 손실 시 거래 중단
- 일일 최대 손실 5% 제한
- 일일 최대 거래 횟수 2회 제한

---

## 2. 설치 방법

### 2.1 시스템 요구사항

**운영체제:**
- macOS 10.15 이상
- Linux (Ubuntu 18.04 이상)
- Windows 10 이상

**Python 버전:**
- Python 3.8 이상 (3.9 권장)

**최소 사양:**
- RAM: 4GB 이상
- 디스크 공간: 1GB 이상
- 인터넷 연결 (데이터 다운로드용)

### 2.2 의존성 설치

#### 방법 1: 자동 설치 (권장)

```bash
# ver2 디렉토리로 이동
cd 005_money/001_python_code/ver2/

# requirements.txt로 일괄 설치
pip install -r requirements.txt
```

#### 방법 2: 수동 설치

```bash
# 핵심 라이브러리
pip install backtrader==1.9.76.123
pip install pandas>=1.3.0
pip install numpy>=1.21.0

# 데이터 수집
pip install python-binance>=1.0.0
pip install requests>=2.26.0

# GUI 및 시각화
pip install matplotlib>=3.4.0
pip install tkinter  # 대부분 Python에 기본 포함됨
```

### 2.3 설치 확인

```bash
# Python 버전 확인
python --version
# 출력 예: Python 3.9.7

# 필수 패키지 확인
python -c "import backtrader, pandas, numpy, matplotlib"
# 오류 없으면 설치 성공
```

---

## 3. 실행 방법

### 3.1 백테스팅 실행

#### 기본 백테스팅 (10개월, $10,000 초기 자본)

```bash
cd 005_money/001_python_code/ver2/
python main_v2.py
```

**출력 예시:**
```
============================================================
BACKTEST COMPLETE - Final Statistics
============================================================
Initial Capital: $10,000.00
Final Value: $13,500.00
Total Return: +35.00%
Total Trades: 48
============================================================

PERFORMANCE REPORT
============================================================
💰 수익성:
   시작 자본: $10,000.00
   최종 자본: $13,500.00
   순이익: $3,500.00
   총 수익률: +35.00%

📉 리스크 지표:
   최대 낙폭 (MDD): 12.50%
   샤프 비율: 1.65

📊 거래 통계:
   총 거래 수: 48
   승리 거래: 28
   손실 거래: 20
   승률: 58.33%
```

#### 커스텀 백테스팅

```bash
# 6개월 백테스팅
python main_v2.py --months 6

# 초기 자본 변경
python main_v2.py --capital 50000

# 차트 생성
python main_v2.py --plot

# 이더리움 백테스팅
python main_v2.py --symbol ETHUSDT

# 조합 사용
python main_v2.py --months 12 --capital 20000 --plot
```

### 3.2 GUI 실행

#### 방법 1: Python 런처 (권장)

```bash
cd 005_money/001_python_code/ver2/
python run_gui_v2.py
```

#### 방법 2: 직접 실행

```bash
cd 005_money/001_python_code
python -m ver2.gui_app_v2
```

#### 방법 3: 프로젝트 루트에서 실행

```bash
cd 005_money
python 001_python_code/ver2/run_gui_v2.py
```

### 3.3 테스트 실행

```bash
# 유닛 테스트 실행
cd 005_money/001_python_code/ver2/
python test_strategy_v2.py

# 또는 pytest 사용
pytest test_strategy_v2.py -v
```

**테스트 항목:**
- 리스크 관리자 검증 (8개 테스트)
- 포지션 관리자 검증 (2개 테스트)
- 시나리오 테스트 (3개 테스트)
- 시장 체제 필터 테스트 (3개 테스트)

---

## 4. GUI 사용법

### 4.1 전체 레이아웃 개요

GUI는 5개의 주요 탭으로 구성되어 있습니다:

```
┌─────────────────────────────────────────────────────────┐
│  🎮 봇 제어: [🚀 봇 시작] [⏹ 봇 정지] ⚪ 대기 중          │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────┐   │
│  │ [거래 현황][📊 실시간 차트][📊 멀티][📋 신호][📜]│   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  (선택한 탭의 내용이 여기에 표시됩니다)                      │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 4.2 탭 1: 거래 현황 (메인 탭)

**레이아웃:** 2단 구조 (왼쪽 컬럼 + 오른쪽 컬럼) + 하단 콘솔

#### 왼쪽 컬럼

**🔍 시장 상태 (Daily EMA)**
- **Regime**: 현재 시장 체제 (BULLISH/BEARISH/NEUTRAL)
  - 🟢 BULLISH: 상승 추세, 거래 허용
  - 🔴 BEARISH: 하락 추세, 거래 중단
  - ⚪ NEUTRAL: 데이터 부족
- **EMA 50**: 일봉 50일 지수이동평균
- **EMA 200**: 일봉 200일 지수이동평균
- **거래 허용 여부**: EMA 50 > EMA 200일 때만 신규 진입 허용

**🎯 진입 신호 점수 (4H Entry Score)**
- **총 점수**: 0-4점 (3점 이상 시 매수 신호)
- **BB 하단 터치**: +1점 (가격이 볼린저밴드 하단선 터치)
- **RSI 과매도**: +1점 (RSI < 30)
- **스토캐스틱 RSI 교차**: +2점 (K선이 D선 상향 돌파 + 과매도 구간)
- **진입 임계값**: 3점 이상

**💼 포지션 상태**
- **포지션 단계**:
  - INITIAL_ENTRY: 초기 진입 (50% 포지션)
  - RISK_FREE_RUNNER: 첫 목표가 달성, 손절가 본전 이동
  - NONE: 포지션 없음
- **진입 가격**: 매수 평균 단가
- **포지션 크기**: 보유 수량
- **첫 목표가 달성 여부**: BB 중심선 도달 여부

#### 오른쪽 컬럼

**📊 거래 상태**
- **현재 코인**: BTC (비트코인)
- **현재 가격**: 실시간 시장 가격
- **실행 간격**: 4H (4시간봉 기준)
- **마지막 액션**: HOLD/BUY/SELL

**📉 Chandelier Exit (샹들리에 손절매)**
- **손절가**: 현재 추적 손절매 가격
- **ATR 배수**: 3.0x (고정)
- **최고가**: 진입 이후 최고점
- **본전 이동 여부**: 첫 목표가 달성 후 손절가가 본전으로 이동됨

**💰 수익 현황**
- **총 수익**: 누적 손익 금액
- **승률**: 전체 거래 대비 수익 거래 비율
- **총 거래 수**: 완료된 거래 횟수

#### 하단 콘솔

실시간 로그 메시지 표시:
- 시장 체제 변경 알림
- 진입 신호 발생 (점수 상세 분석)
- 포지션 상태 전환
- 손절매/익절매 실행
- 시스템 이벤트

### 4.3 탭 2: 📊 실시간 차트

**기능:**
- **타임프레임 선택기**: 1h, 4h, 1d 중 선택
- **지표 토글 체크박스**:
  - ✓ EMA (50/200일)
  - ✓ 볼린저밴드
  - ✓ RSI
  - ✓ 스토캐스틱 RSI
  - ✓ ATR
- **🔄 새로고침 버튼**: 최신 데이터 갱신

**차트 구성:**

```
┌────────────────────────────────────────────┐
│  가격 차트 (캔들스틱)                         │
│  - 볼린저밴드 (회색 점선)                     │
│  - EMA 50 (주황), EMA 200 (보라)            │
├────────────────────────────────────────────┤
│  RSI (14)                                  │
│  - 과매도 라인 (30)                          │
│  - 과매수 라인 (70)                          │
├────────────────────────────────────────────┤
│  Stochastic RSI                            │
│  - %K 라인 (파랑)                            │
│  - %D 라인 (주황)                            │
│  - 과매도 라인 (20)                          │
├────────────────────────────────────────────┤
│  ATR (14)                                  │
│  - 변동성 지표                               │
└────────────────────────────────────────────┘
```

**사용 팁:**
- 지표 체크박스를 끄면 해당 서브플롯이 숨겨짐
- 4H 타임프레임이 전략 실행 기준이므로 권장
- 일봉(1d)에서 EMA 50/200 크로스 확인 가능

### 4.4 탭 3: 📊 멀티 타임프레임

**현재 상태:** 개발 예정 (Coming Soon)

**계획된 기능:**
- 일봉/4시간봉/1시간봉 3단 동시 표시
- 타임프레임 간 시그널 동기화
- 전략 흐름 시각화 (일봉 체제 → 4H 진입 신호)

### 4.5 탭 4: 📋 신호 히스토리

**상단 통계:**
- **총 신호 수**: 발생한 모든 신호 개수
- **평균 진입 점수**: 진입 신호의 평균 점수
- **강세장 신호 수**: BULLISH 체제에서 발생한 신호 개수
- **성공률**: 수익 거래 비율

**신호 테이블:**

| 시간 | 유형 | 체제 | 점수 | 구성요소 | 가격 | 결과 |
|------|------|------|------|----------|------|------|
| 2025-10-01 08:00 | ENTRY | BULLISH | 4 | BB+1, RSI+1, Stoch+2 | $48,500 | +2.5% |
| 2025-10-02 12:00 | EXIT | BULLISH | - | Chandelier Stop | $49,500 | +2.1% |

**기능:**
- **더블 클릭**: 신호 상세 정보 팝업
- **💾 내보내기**: JSON 파일로 저장
- **🗑️ 히스토리 초기화**: 모든 기록 삭제
- **자동 필터링**: 진입/청산 신호 매칭

### 4.6 탭 5: 📜 거래 내역

**거래 테이블:**

| 시간 | 유형 | 가격 | 수량 | 총액 | 손익 |
|------|------|------|------|------|------|
| 2025-10-01 08:00 | BUY | $48,500 | 0.025 BTC | $1,212.50 | - |
| 2025-10-01 16:00 | SELL | $49,500 | 0.0125 BTC | $618.75 | +$12.50 |
| 2025-10-02 00:00 | SELL | $51,000 | 0.0125 BTC | $637.50 | +$31.25 |

**거래 유형:**
- **BUY**: 매수 (진입)
- **SELL**: 매도 (청산)

**손익 계산:**
- 매수: 손익 표시 안 됨
- 매도: (매도가 - 평균매수가) × 수량

---

## 5. 설정 변경 방법

### 5.1 config_v2.py 파라미터 설명

설정 파일 위치: `/Users/seongwookjang/project/git/violet_sw/005_money/001_python_code/ver2/config_v2.py`

#### 타임프레임 설정

```python
TIMEFRAME_CONFIG = {
    'execution_interval': '4h',    # 진입/청산 타임프레임
    'regime_interval': '1d',        # 시장 체제 분석 타임프레임
    'execution_candles': 200,       # 4H 데이터 개수 (약 33일)
    'regime_candles': 250,          # 일봉 데이터 개수 (EMA 200 계산용)
}
```

**변경 가능 항목:**
- `execution_interval`: 진입 신호 생성 간격
  - 옵션: '1h', '2h', '4h', '6h', '12h'
  - 기본값: '4h' (권장)
  - 주의: 간격이 짧을수록 신호 빈도 증가하나 신뢰도 하락

#### 시장 체제 필터 설정

```python
REGIME_FILTER_CONFIG = {
    'ema_fast': 50,                 # 빠른 EMA 기간
    'ema_slow': 200,                # 느린 EMA 기간
    'bullish_regime': 'ema50 > ema200',
    'allow_long_in_bullish': True,  # 강세장에서 롱 허용
    'allow_long_in_bearish': False, # 약세장에서 롱 차단
    'allow_short': False,           # 숏 거래 비활성화
}
```

**변경 예시:**
```python
# 더 빠른 체제 감지 (단, 휘플 위험 증가)
'ema_fast': 20,
'ema_slow': 50,

# 약세장에서도 거래 (비권장)
'allow_long_in_bearish': True,
```

#### 진입 점수 시스템

```python
ENTRY_SCORING_CONFIG = {
    'min_entry_score': 3,           # 최소 진입 점수
    'scoring_rules': {
        'bb_touch': {
            'enabled': True,
            'points': 1,
            'condition': 'low <= bb_lower',
        },
        'rsi_oversold': {
            'enabled': True,
            'points': 1,
            'condition': 'rsi < 30',
        },
        'stoch_rsi_cross': {
            'enabled': True,
            'points': 2,
            'condition': 'stoch_k crosses above stoch_d AND stoch_k < 20',
        },
    },
}
```

**조정 가능 항목:**
- `min_entry_score`: 2로 낮추면 신호 증가 (단, 품질 하락)
- `points`: 각 조건의 가중치 변경 가능
- `enabled`: 특정 조건 비활성화 가능

#### 지표 파라미터

```python
INDICATOR_CONFIG = {
    # 볼린저밴드
    'bb_period': 20,                # 기간
    'bb_std': 2.0,                  # 표준편차 배수

    # RSI
    'rsi_period': 14,               # 기간
    'rsi_oversold': 30,             # 과매도 기준

    # 스토캐스틱 RSI
    'stoch_rsi_period': 14,         # RSI 기간
    'stoch_period': 14,             # 스토캐스틱 기간
    'stoch_k_smooth': 3,            # K선 평활화
    'stoch_d_smooth': 3,            # D선 평활화
    'stoch_oversold': 20,           # 과매도 기준

    # ATR (변동성)
    'atr_period': 14,               # 기간
    'chandelier_multiplier': 3.0,   # 샹들리에 배수
}
```

**최적화 가이드:**
- **변동성 높은 시장**: `chandelier_multiplier` 3.5~4.0으로 증가
- **변동성 낮은 시장**: `chandelier_multiplier` 2.5~3.0으로 감소
- **RSI 민감도 증가**: `rsi_oversold` 35로 증가
- **스토캐스틱 평활화 강화**: `stoch_k_smooth` 5로 증가

#### 포지션 관리

```python
POSITION_CONFIG = {
    'initial_position_pct': 50,     # 초기 진입 비율 (%)
    'first_target_pct': 50,         # 첫 목표가 청산 비율 (%)
    'second_target_pct': 100,       # 두 번째 목표가 청산 비율 (%)
    'risk_per_trade_pct': 2.0,      # 거래당 리스크 (%)
    'use_atr_sizing': True,         # ATR 기반 포지션 사이징
}
```

**보수적 설정:**
```python
'initial_position_pct': 40,         # 더 작은 초기 진입
'risk_per_trade_pct': 1.0,          # 리스크 반감
```

**공격적 설정:**
```python
'initial_position_pct': 60,         # 더 큰 초기 진입
'risk_per_trade_pct': 3.0,          # 리스크 증가 (주의!)
```

#### 위험 관리

```python
RISK_CONFIG = {
    'stop_loss_type': 'chandelier',         # 손절 유형
    'chandelier_atr_multiplier': 3.0,       # ATR 배수
    'fixed_stop_loss_pct': 5.0,             # 고정 손절 (fallback)
    'breakeven_after_first_target': True,   # 첫 목표 후 본전 이동
    'max_daily_loss_pct': 3.0,              # 일일 최대 손실 (%)
    'max_consecutive_losses': 3,            # 최대 연속 손실
    'max_daily_trades': 5,                  # 일일 최대 거래
    'max_position_size_pct': 10.0,          # 최대 포지션 크기 (%)
}
```

**극도로 보수적 설정:**
```python
'max_daily_loss_pct': 2.0,          # 일일 손실 2%로 제한
'max_consecutive_losses': 2,        # 2회 연속 손실 시 중단
'max_daily_trades': 1,              # 하루 1거래만 허용
```

#### 백테스팅 설정

```python
BACKTESTING_CONFIG = {
    'initial_capital': 10000.0,     # 초기 자본 (USD)
    'commission': 0.001,            # 수수료 (0.1%)
    'slippage': 0.0005,             # 슬리피지 (0.05%)
    'lookback_months': 10,          # 백테스팅 기간 (개월)
}
```

### 5.2 설정 변경 프로세스

1. **백업 생성**
   ```bash
   cp config_v2.py config_v2_backup.py
   ```

2. **파일 편집**
   ```bash
   nano config_v2.py
   # 또는
   vi config_v2.py
   # 또는 IDE에서 열기
   ```

3. **설정 검증**
   ```bash
   python -c "from ver2 import config_v2; print('설정 로드 성공')"
   ```

4. **백테스팅으로 검증**
   ```bash
   python main_v2.py --months 3
   ```

5. **문제 발생 시 복원**
   ```bash
   cp config_v2_backup.py config_v2.py
   ```

---

## 6. 거래 전략 이해하기

### 6.1 전략 철학

**핵심 원칙:**
1. **큰 흐름을 따른다** (일봉 EMA 50/200 골든크로스)
2. **작은 파도에서 진입한다** (4시간봉 과매도 신호)
3. **수익은 키우고, 손실은 빠르게 자른다** (샹들리에 추적 손절)
4. **확률이 높은 곳에만 베팅한다** (3점 이상 신호만 진입)

### 6.2 일봉 시장 체제 필터 (1단계)

**골든크로스/데드크로스 전략**

```
일봉 차트에서:

EMA 50 > EMA 200
      ↓
   🟢 BULLISH (강세장)
      ↓
   거래 허용


EMA 50 ≤ EMA 200
      ↓
   🔴 BEARISH (약세장)
      ↓
   거래 차단 (기존 포지션 청산만 가능)
```

**왜 효과적인가?**
- 과거 10년 데이터 분석 결과, 골든크로스 상태에서 승률 15-20% 상승
- 최대 낙폭(MDD) 30-50% 감소
- 2021년 5월, 2022년 6-11월 하락장 회피

**체제 전환 예시:**

| 날짜 | EMA 50 | EMA 200 | 체제 | 액션 |
|------|---------|---------|------|------|
| 2024-01-01 | $42,000 | $45,000 | BEARISH | 거래 중단 |
| 2024-02-01 | $48,000 | $46,000 | BULLISH | 거래 시작 |
| 2024-08-01 | $62,000 | $58,000 | BULLISH | 거래 유지 |

### 6.3 4시간봉 진입 시스템 (2단계)

**점수 기반 신호 생성**

#### 조건 1: 볼린저밴드 하단 터치 (+1점)

```
의미: 가격이 통계적으로 과매도 구간 진입 (평균 - 2σ)

발생 조건:
  현재 4시간봉의 저가 ≤ 볼린저밴드 하단선

예시:
  BB 하단: $48,000
  현재봉 저가: $47,900
    → +1점 획득

빈도: 월 2-3회 (강세장 기준)
```

#### 조건 2: RSI 과매도 (+1점)

```
의미: 모멘텀 고갈 확인

발생 조건:
  RSI(14) < 30

예시:
  RSI: 28.5
    → +1점 획득

빈도: 월 1-2회 (강세장에서는 드묾)
신뢰도: ★★★★☆ (BB와 함께 발생 시 매우 강력)
```

#### 조건 3: 스토캐스틱 RSI 교차 (+2점)

```
의미: 모멘텀 반전 신호 (가장 중요한 타이밍 지표)

발생 조건:
  1. 이전 봉: K선 < D선
  2. 현재 봉: K선 > D선 (상향 돌파)
  3. 둘 다 과매도 구간 (K < 20, D < 20)

예시:
  이전봉 - K: 15, D: 18
  현재봉 - K: 22, D: 20
    → +2점 획득

빈도: 월 3-5회
신뢰도: ★★★★★ (가격 반전 1-3봉 선행)
```

#### 진입 조합 예시

**완벽한 진입 (4점):**
```
✓ BB 하단 터치 (+1)
✓ RSI < 30 (+1)
✓ Stoch RSI 교차 (+2)
─────────────────────
= 4점 → 즉시 진입!

예상 승률: 70-75%
발생 빈도: 월 1-2회
```

**강한 진입 (3점):**
```
✓ BB 하단 터치 (+1)
✗ RSI 정상 (+0)
✓ Stoch RSI 교차 (+2)
─────────────────────
= 3점 → 진입 가능

예상 승률: 60-65%
발생 빈도: 월 2-3회
```

**약한 신호 (2점):**
```
✓ BB 하단 터치 (+1)
✓ RSI < 30 (+1)
✗ Stoch 교차 없음 (+0)
─────────────────────
= 2점 → 진입 거부

이유: 타이밍 지표 부재
```

### 6.4 포지션 관리 프로토콜

**4단계 포지션 생애주기:**

```
┌─────────────────────────────────────────────────────────┐
│ 단계 1: 초기 진입 (INITIAL_ENTRY)                        │
├─────────────────────────────────────────────────────────┤
│ 진입 신호: 점수 ≥ 3                                      │
│ 매수 크기: 전체 계산 크기의 50%                            │
│ 리스크: 포트폴리오의 1% (2%의 절반)                        │
│ 손절가: 진입가 - (ATR × 3.0)                             │
│                                                         │
│ 예시:                                                   │
│   포트폴리오: $10,000                                    │
│   진입가: $48,500                                        │
│   ATR: $500                                             │
│   손절가: $48,500 - ($500 × 3) = $47,000               │
│   손실 거리: $1,500                                      │
│   최대 손실: $10,000 × 1% = $100                        │
│   포지션 크기: $100 / $1,500 = 0.0667 BTC (50% 진입)   │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 단계 2: 첫 목표가 달성 (FIRST_TARGET_HIT)                │
├─────────────────────────────────────────────────────────┤
│ 트리거: 가격이 BB 중심선 도달                              │
│ 청산: 현재 포지션의 50% 매도                              │
│ 수익: 약 1.0R (1% 포트폴리오 수익)                        │
│ 손절가 이동: 본전 (진입가)으로 상향                        │
│ 심리적 효과: 리스크 제거, 스트레스 감소                     │
│                                                         │
│ 예시:                                                   │
│   진입가: $48,500                                        │
│   BB 중심선: $49,500                                     │
│   청산: 0.0333 BTC (절반)                                │
│   수익: ($49,500 - $48,500) × 0.0333 = $33.30          │
│   새 손절가: $48,500 (본전)                              │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 단계 3: 리스크 프리 러너 (RISK_FREE_RUNNER)               │
├─────────────────────────────────────────────────────────┤
│ 상태: 남은 포지션 25% (원래 전체 크기의 절반의 절반)        │
│ 손절가: 본전 (리스크 0%)                                  │
│ 관리: 샹들리에 엑시트가 계속 추적                          │
│ 목표: 큰 상승 추세 포착                                   │
│                                                         │
│ 이 단계의 의미:                                           │
│   - 이미 1% 수익 확보                                     │
│   - 남은 포지션은 "하우스 머니" (손실 불가능)               │
│   - 심리적 여유 → 더 긴 보유 가능                          │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ 단계 4: 최종 청산 (FINAL_EXIT)                           │
├─────────────────────────────────────────────────────────┤
│ 시나리오 A: BB 상단선 도달                                │
│   - 가격이 BB 상단 (평균 + 2σ) 돌파                       │
│   - 남은 25% 전량 청산                                    │
│   - 추가 수익: 약 1.5R                                   │
│   - 총 수익: 1.0R + 0.375R = 1.375R (1.375%)            │
│                                                         │
│ 시나리오 B: 샹들리에 손절 발동                             │
│   - 가격이 추적 손절가 터치                                │
│   - 남은 25% 전량 청산                                    │
│   - 수익: 손절가가 올라온 만큼 (보통 0.5-1.0R)            │
│   - 총 수익: 1.0R + 0.25R ~ 0.5R = 1.25R ~ 1.5R         │
└─────────────────────────────────────────────────────────┘
```

### 6.5 실전 거래 예시

**예시 1: 완벽한 4점 진입**

```
날짜: 2025-10-01
시간: 08:00 (4시간봉 마감)
시장 상황:
  - 일봉 EMA 50: $50,000
  - 일봉 EMA 200: $48,000
  - 체제: BULLISH ✓

4시간봉 신호:
  - 현재가: $48,500
  - BB 하단: $48,600 → 저가 $48,400 (터치!) ✓ +1점
  - RSI: 28 (< 30) ✓ +1점
  - Stoch K: 22, Stoch D: 18 (교차!) ✓ +2점
  - 총점: 4점 → 진입 결정!

진입 실행:
  - 포트폴리오: $10,000
  - 진입가: $48,500
  - ATR: $600
  - 손절가: $48,500 - ($600 × 3) = $46,700
  - 리스크: $1,800 (진입가 - 손절가)
  - 최대 손실: $10,000 × 1% = $100
  - 포지션: $100 / $1,800 = 0.0556 BTC (50% 진입)
  - 실제 매수: 0.0278 BTC (약 $1,348)

08시간 후 (16:00):
  - 가격: $49,500 (BB 중심선 도달)
  - 청산: 0.0139 BTC (50%)
  - 수익: ($49,500 - $48,500) × 0.0139 = $13.90
  - 손절가 이동: $48,500 (본전)

24시간 후 (다음날 08:00):
  - 가격: $51,200 (BB 상단 근접)
  - 샹들리에 손절: $49,800 (계속 추적 중)
  - 보유: 0.0139 BTC

32시간 후 (다음날 16:00):
  - 가격: $50,800 (조정)
  - 샹들리에 손절 발동: $50,200
  - 청산: 0.0139 BTC (잔량)
  - 수익: ($50,200 - $48,500) × 0.0139 = $23.63

총 손익:
  - 첫 청산: +$13.90
  - 최종 청산: +$23.63
  - 합계: +$37.53 (포트폴리오 대비 +0.38%)
  - R 배수: 약 0.37R (실제 리스크는 1R이었으나 분할 청산으로 감소)
```

---

## 7. 위험 관리 기능

### 7.1 샹들리에 엑시트 (Chandelier Exit)

**개념:**
"샹들리에처럼 천장에 매달린 손절매"

```
손절가 = 진입 이후 최고가 - (ATR × 3)

특징:
  - 가격이 오르면 손절가도 함께 상승 (추적)
  - 가격이 내리면 손절가는 유지 (고정)
  - 변동성(ATR)에 따라 동적으로 조정
```

**고정 손절 vs 샹들리에 손절 비교:**

| 항목 | 고정 손절 (5%) | 샹들리에 (3×ATR) |
|------|----------------|------------------|
| 변동성 적응 | 없음 | 있음 |
| 노이즈 스탑 | 빈번 | 거의 없음 |
| 수익 보호 | 수동 | 자동 추적 |
| 심리적 부담 | 높음 | 낮음 |

**ATR 배수별 효과:**

| ATR 배수 | 손절 거리 | 특징 | 추천 시장 |
|----------|-----------|------|-----------|
| 2.0x | 좁음 | 빠른 청산, 높은 정확도 필요 | 저변동성 |
| 3.0x | 중간 | 균형 잡힌 설정 (기본값) | 일반 |
| 4.0x | 넓음 | 큰 변동 허용, 장기 보유 | 고변동성 |

### 7.2 포지션 사이징 (2% 룰)

**기본 원칙:**
"한 번의 거래에서 포트폴리오의 2% 이상 잃지 않는다"

```python
# 포지션 사이징 공식
max_loss_usd = portfolio_value × 0.02
stop_distance = entry_price - stop_loss_price
position_size = max_loss_usd / stop_distance

# 예시
portfolio_value = $10,000
max_loss_usd = $10,000 × 0.02 = $200
entry_price = $50,000
stop_loss_price = $48,500
stop_distance = $50,000 - $48,500 = $1,500

position_size = $200 / $1,500 = 0.1333 BTC

# 50% 초기 진입
initial_entry = 0.1333 × 0.50 = 0.0667 BTC
```

**복리 효과:**

| 거래 수 | 승률 60% | 평균 수익 1.2R | 포트폴리오 성장 |
|---------|---------|----------------|----------------|
| 0 | - | - | $10,000 |
| 10 | 6승 4패 | +4R | $10,800 |
| 20 | 12승 8패 | +8R | $11,664 |
| 30 | 18승 12패 | +12R | $12,597 |

### 7.3 연속 손실 제한 (회로차단기)

**로직:**
```python
if consecutive_losses >= 5:
    print("🛑 회로차단기 발동!")
    print("5회 연속 손실 발생. 거래 중단.")
    print("전략 재검토 및 시장 분석 필요.")
    trading_allowed = False
```

**재시작 조건:**
- 수동 재시작: 사용자가 설정 확인 후 리셋
- 자동 재시작: 1회 수익 거래 발생 시

**심리적 효과:**
- 연패 시 감정적 거래 방지
- 전략 오작동 조기 발견
- 자본 보존

### 7.4 일일 손실 한도 (5% 룰)

**로직:**
```python
daily_loss_pct = (daily_pnl / portfolio_value) × 100

if daily_loss_pct <= -5.0:
    print("⚠️ 일일 손실 한도 도달!")
    print(f"당일 손실: {daily_loss_pct:.2f}%")
    print("오늘은 거래 중단. 내일 재시작.")
    trading_allowed_today = False
```

**목적:**
- 하루에 큰 손실 방지
- 변동성 급증 시 자본 보호
- 감정적 복구 거래 차단

**실제 사례:**
```
2022년 5월 LUNA 사태:
  - 하루 -30% 변동
  - 일일 한도 없이 거래 시: -15% 손실 가능
  - 일일 한도 5% 적용 시: -5% 손실로 제한
  - 차이: 10% 자본 보존
```

### 7.5 일일 거래 횟수 제한

**설정:**
```python
MAX_DAILY_TRADES = 2  # 하루 최대 2회 진입
```

**이유:**
- 과도한 거래 방지 (수수료 절감)
- 신호 품질 강제 (낮은 점수 신호 회피)
- 감정적 보복 거래 차단

**예외 처리:**
```python
# 청산은 거래 횟수에 포함 안 됨
# 오직 신규 진입만 카운트
```

---

## 8. 문제 해결 가이드

### 8.1 설치 관련 문제

#### 문제: "ModuleNotFoundError: No module named 'backtrader'"

**원인:** backtrader 패키지 미설치

**해결:**
```bash
pip install backtrader
```

**또는:**
```bash
pip install -r requirements.txt
```

#### 문제: "tkinter 모듈을 찾을 수 없습니다"

**원인:** macOS/Linux에서 tkinter 누락

**해결 (macOS):**
```bash
brew install python-tk
```

**해결 (Ubuntu/Debian):**
```bash
sudo apt-get install python3-tk
```

#### 문제: "pip: command not found"

**원인:** pip 미설치 또는 PATH 문제

**해결:**
```bash
# Python 3.8+ 사용 시
python3 -m pip install backtrader

# 또는 pip 설치
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python3 get-pip.py
```

### 8.2 실행 관련 문제

#### 문제: "거래가 전혀 실행되지 않습니다"

**원인 1:** 백테스팅 기간이 약세장(BEARISH)

**확인:**
```bash
# 콘솔 로그에서 확인
[Regime] Current: BEARISH → Trading blocked
```

**해결:**
```bash
# 더 긴 기간으로 백테스팅
python main_v2.py --months 12
```

**원인 2:** 진입 점수 임계값이 너무 높음

**확인:**
```python
# config_v2.py 확인
ENTRY_SCORING_CONFIG = {
    'min_entry_score': 3,  # 너무 높을 수 있음
}
```

**해결:**
```python
# config_v2.py 수정
'min_entry_score': 2,  # 임계값 낮춤
```

**원인 3:** 위험 관리자가 거래 차단

**확인:**
```bash
# 로그 확인
[RiskManager] Entry rejected: Max daily trades reached
[RiskManager] Entry rejected: Consecutive losses limit
```

**해결:**
```python
# config_v2.py에서 제한 완화
RISK_CONFIG = {
    'max_daily_trades': 10,  # 증가
    'max_consecutive_losses': 10,  # 증가
}
```

#### 문제: "ImportError: attempted relative import with no known parent package"

**원인:** 잘못된 디렉토리에서 실행

**해결:**
```bash
# 반드시 ver2 디렉토리에서 실행
cd 005_money/001_python_code/ver2/
python main_v2.py

# 또는 프로젝트 루트에서
cd 005_money
python -m 001_python_code.ver2.main_v2
```

#### 문제: "Data validation failed: Insufficient data"

**원인:** 네트워크 문제 또는 Binance API 접근 불가

**해결:**
```bash
# 인터넷 연결 확인
ping api.binance.com

# 수동으로 데이터 다운로드 테스트
python -c "from binance.client import Client; c = Client(); print(c.get_klines(symbol='BTCUSDT', interval='1h', limit=10))"
```

### 8.3 GUI 관련 문제

#### 문제: "GUI 창이 열리지 않습니다"

**원인:** tkinter 관련 문제

**해결:**
```bash
# 의존성 확인
python run_gui_v2.py
# 스크립트가 자동으로 확인 후 안내 메시지 출력
```

**수동 확인:**
```bash
python -c "import tkinter; print('tkinter OK')"
```

#### 문제: "차트가 표시되지 않습니다"

**원인:** matplotlib backend 문제

**해결:**
```python
# chart_widget_v2.py 상단에 추가
import matplotlib
matplotlib.use('TkAgg')
```

#### 문제: "GUI가 멈춥니다 (응답 없음)"

**원인:** 메인 스레드에서 무거운 작업 실행

**해결:** 봇 재시작
```
1. GUI에서 "⏹ 봇 정지" 클릭
2. 5초 대기
3. "🚀 봇 시작" 클릭
```

### 8.4 성능 관련 문제

#### 문제: "백테스팅이 너무 느립니다"

**원인:** 데이터 양이 많거나 시스템 사양 부족

**해결:**
```bash
# 백테스팅 기간 단축
python main_v2.py --months 3

# 또는 데이터 캐싱
# (main_v2.py가 자동으로 캐싱하지만, 삭제 시 재다운로드 필요)
```

#### 문제: "메모리 부족 오류"

**원인:** 너무 많은 데이터 로딩

**해결:**
```python
# config_v2.py에서 데이터 개수 감소
TIMEFRAME_CONFIG = {
    'execution_candles': 100,  # 200 → 100
    'regime_candles': 150,     # 250 → 150
}
```

### 8.5 데이터 관련 문제

#### 문제: "가격 데이터가 이상합니다"

**원인:** API 응답 오류 또는 네트워크 문제

**해결:**
```bash
# 캐시 삭제 후 재다운로드
rm -rf cache/
python main_v2.py
```

#### 문제: "Error: Symbol not found"

**원인:** 잘못된 심볼 입력

**해결:**
```bash
# 올바른 심볼 형식 사용
python main_v2.py --symbol BTCUSDT  # O
python main_v2.py --symbol BTC/USDT  # X
```

---

## 9. FAQ

### 9.1 전략 관련

**Q1: 왜 4시간봉을 사용하나요? 1시간봉은 안 되나요?**

A: 4시간봉은 노이즈와 신호의 균형이 가장 좋습니다.
- 1시간봉: 신호 많음 (월 15-20회), 승률 낮음 (45-50%)
- 4시간봉: 신호 적정 (월 5-8회), 승률 높음 (55-65%)
- 일봉: 신호 적음 (월 1-2회), 기회 부족

**Q2: 승률 60%면 40%는 손실인데 괜찮나요?**

A: 승률보다 중요한 것은 **기대값(Expected Value)**입니다.
```
승률 60%, 평균 수익 1.5R, 평균 손실 1R일 때:
기대값 = (0.6 × 1.5R) - (0.4 × 1R) = 0.9R - 0.4R = +0.5R

→ 거래당 평균 +0.5% 수익
→ 20거래 시 +10% 수익
```

**Q3: 왜 롱(매수)만 하고 숏(공매도)은 안 하나요?**

A: 비트코인은 장기적으로 상승 추세를 보이는 자산입니다.
- 2015-2024: 연평균 +120% 수익률
- 숏 거래: 추세에 역행, 리스크 높음
- v2 전략: 추세를 따르는 보수적 설계

롱 전용 전략이 백테스트 결과 더 우수한 성과를 보였습니다.

**Q4: 점수 임계값을 2점으로 낮추면 안 되나요?**

A: 가능하지만 권장하지 않습니다.
- 3점 → 2점 변경 시:
  - 신호 빈도: +50% 증가
  - 승률: -10% ~ -15% 감소
  - 최대 낙폭(MDD): +5% ~ +8% 증가

**안정성 > 빈도** 우선 원칙에 따라 3점 권장

### 9.2 설정 관련

**Q5: ATR 배수를 2.5로 줄이면 손절이 빨라서 좋지 않나요?**

A: 더 빠른 손절 ≠ 더 좋은 결과
```
ATR 2.5x:
  - 장점: 손실 폭 작음
  - 단점: 노이즈 스탑 증가 (승률 -15%)

ATR 3.0x (기본):
  - 균형 잡힌 설정
  - 백테스트 최적값

ATR 3.5x:
  - 장점: 노이즈 스탑 감소
  - 단점: 큰 손실 시 손실 폭 증가
```

**Q6: 초기 진입을 100%로 하면 수익이 더 크지 않나요?**

A: 단기적으로는 맞지만, 장기적으로는 위험합니다.
```
100% 진입 시:
  - 수익 거래: 100% × 수익률
  - 손실 거래: 100% × 손실률 (2배 타격)
  - 심리적 부담 증가

50% 분할 진입 시:
  - 손실 거래: 50% × 손실률 (부담 감소)
  - 목표가 달성 시 리스크 0% 전환
  - 장기 생존율 향상
```

**최대 낙폭(MDD) 비교:**
- 100% 진입: -18% ~ -25%
- 50% 진입: -10% ~ -15%

### 9.3 성과 관련

**Q7: 10개월 백테스트에서 +35% 수익이면 실제로도 그렇게 나오나요?**

A: 실제 수익률은 백테스트보다 **20-30% 낮습니다**.

**백테스트와 실제 차이 원인:**
- 슬리피지: 주문 체결 시 가격 차이
- 수수료: 백테스트는 0.1%, 실제는 더 높을 수 있음
- 거래소 다운타임: API 오류, 서버 점검
- 블랙스완: 급격한 시장 붕괴 (2022년 LUNA 사태 등)

**현실적 기대치:**
- 백테스트: +35%
- 실제: +25% ~ +28%

**Q8: 월 수익률이 어느 정도 나오나요?**

A: 월별 편차가 큽니다.
```
좋은 달: +8% ~ +12%
보통 달: +2% ~ +5%
나쁜 달: -3% ~ +1%

연평균: +25% ~ +35% (복리)
```

**Q9: 최대 낙폭(MDD)이 -12%인데 견딜 수 있을까요?**

A: MDD는 **최악의 순간**입니다.
```
MDD -12% 의미:
  $10,000 → $8,800 (최저점)

대부분의 시간:
  - 낙폭 -3% ~ -5% 수준
  - MDD는 백테스트 기간 중 1회 발생
```

**심리적 준비:**
- MDD는 반드시 발생합니다
- 견디지 못하면 손절 후 회복 기회 상실
- 장기 투자 관점 필요

### 9.4 실전 투자 관련

**Q10: 실제 돈으로 투자해도 되나요?**

A: **반드시 소액으로 시작하세요.**

**권장 단계:**
```
1단계: 페이퍼 트레이딩 (1개월)
  - 실제 돈 없이 기록만
  - 전략 이해도 향상

2단계: 소액 실전 ($500 ~ $1,000)
  - 최소 3개월 운영
  - 심리적 적응

3단계: 본격 투자 (감당 가능한 금액)
  - 잃어도 생활에 지장 없는 금액
  - 전체 투자 자산의 5-10%만 할당
```

**절대 금지:**
- ❌ 생활비로 투자
- ❌ 대출받아서 투자
- ❌ 전 재산 올인

**Q11: 어느 거래소를 사용해야 하나요?**

A: 현재 시스템은 **Binance** 기준으로 개발되었습니다.

**이유:**
- API 안정성
- 유동성 (슬리피지 최소화)
- 데이터 품질

**다른 거래소 사용 시:**
- Bithumb: 코드 수정 필요 (이미 일부 지원)
- Upbit: API 제한 확인 필요
- Coinbase: 데이터 형식 변환 필요

**Q12: 24시간 컴퓨터를 켜놔야 하나요?**

A: 4시간봉 전략이므로 **불필요**합니다.

**운영 방법:**
```
방법 1: 수동 체크 (권장 초보자)
  - 4시간마다 확인 (0시, 4시, 8시, 12시, 16시, 20시)
  - GUI로 신호 확인
  - 수동으로 거래소에서 주문

방법 2: 자동화 (클라우드)
  - AWS, GCP 등에 배포
  - 크론잡으로 4시간마다 실행
  - API 연동으로 자동 거래
```

### 9.5 기술 관련

**Q13: Python을 잘 모르는데 사용할 수 있나요?**

A: 기본 실행은 가능하지만, **Python 기초 학습 권장**

**필수 지식:**
```
1. 터미널 사용법
   - cd, ls, python 명령어

2. 파일 편집
   - config_v2.py 수정 방법

3. 에러 읽기
   - 오류 메시지 이해
```

**학습 리소스:**
- Python 공식 튜토리얼: docs.python.org/ko/3/tutorial/
- 유튜브: "파이썬 기초 강의"

**Q14: 백테스팅 결과를 엑셀로 내보낼 수 있나요?**

A: 현재는 콘솔 출력만 지원하지만, **추가 가능**합니다.

**임시 방법:**
```bash
# 콘솔 출력을 파일로 저장
python main_v2.py > results.txt

# 또는 신호 히스토리 JSON 내보내기
# GUI에서 "📋 신호 히스토리" 탭 → "💾 내보내기"
```

**Q15: 다른 코인(알트코인)에도 적용되나요?**

A: 가능하지만 **성과는 다를 수 있습니다**.

**테스트 방법:**
```bash
# 이더리움
python main_v2.py --symbol ETHUSDT

# 바이낸스코인
python main_v2.py --symbol BNBUSDT
```

**주의사항:**
- 알트코인은 변동성이 훨씬 큼
- ATR 배수 조정 필요 (3.5 ~ 4.0)
- 유동성 확인 필수

---

## 10. 추가 리소스

### 10.1 관련 문서

**전략 상세 명세서:**
```
/005_money/004_trade_rule/Strategy_v2_final.md
- 전략 철학 및 수학적 근거
- 백테스팅 결과 상세 분석
- 파라미터 최적화 가이드
```

**빠른 시작 가이드:**
```
/005_money/001_python_code/ver2/QUICKSTART.md
- 5분 안에 첫 백테스트 실행
- 주요 사용 사례
```

**GUI 상세 문서:**
```
/005_money/001_python_code/ver2/GUI_README.md
- GUI 각 탭 기능 설명
- v1 vs v2 비교
```

### 10.2 코드 참조

**주요 모듈:**
```
config_v2.py              - 모든 설정 파라미터
backtrader_strategy_v2.py - 메인 전략 로직
regime_filter_v2.py       - 일봉 EMA 체제 필터
entry_signals_v2.py       - 4H 진입 신호 점수 계산
position_manager_v2.py    - 포지션 사이징 및 샹들리에
risk_manager_v2.py        - 위험 관리 규칙
```

### 10.3 지원 및 문의

**문제 발생 시:**
1. 로그 확인 (콘솔 또는 logs/ 디렉토리)
2. FAQ 섹션 참조
3. 테스트 실행: `python test_strategy_v2.py`

**버그 제보:**
- GitHub Issues (프로젝트 저장소)
- 재현 방법 및 로그 첨부

---

## 11. 면책 조항

**중요: 반드시 읽어주세요**

1. **투자 손실 위험**
   - 본 시스템은 교육 및 연구 목적으로만 제작되었습니다
   - 과거 수익률이 미래 수익을 보장하지 않습니다
   - 암호화폐 투자는 원금 손실 위험이 매우 높습니다

2. **책임의 한계**
   - 본 시스템 사용으로 인한 손실에 대해 개발자는 책임지지 않습니다
   - 모든 투자 결정은 사용자 본인의 책임입니다
   - 전문가의 조언을 구하시기 바랍니다

3. **법적 고지**
   - 본 문서는 금융 투자 자문이 아닙니다
   - 각국의 암호화폐 규제를 확인하시기 바랍니다
   - 세금 문제는 전문가와 상담하세요

4. **시스템 한계**
   - 100% 완벽한 전략은 존재하지 않습니다
   - 예상치 못한 시장 변화에 대응하지 못할 수 있습니다
   - 정기적인 모니터링과 조정이 필요합니다

---

**문서 버전:** 2.0
**최종 업데이트:** 2025-10-03
**작성자:** Trading Bot Team
**라이선스:** 교육 및 연구 목적 전용

**행운을 빕니다! 하지만 항상 신중하게 투자하세요.**
