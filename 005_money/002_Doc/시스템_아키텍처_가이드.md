# 빗썸 엘리트 트레이딩 봇 - 시스템 아키텍처 가이드

**버전**: 3.0 (Elite v2.0 기반)
**최종 수정**: 2025년 10월 2일
**대상 독자**: 개발자, 시스템 관리자, 고급 사용자

---

## 목차

1. [시스템 개요](#1-시스템-개요)
2. [전체 아키텍처](#2-전체-아키텍처)
3. [핵심 모듈 상세 분석](#3-핵심-모듈-상세-분석)
4. [데이터 흐름](#4-데이터-흐름)
5. [의존성 관계](#5-의존성-관계)
6. [설정 관리 시스템](#6-설정-관리-시스템)
7. [로깅 및 모니터링](#7-로깅-및-모니터링)
8. [보안 고려사항](#8-보안-고려사항)

---

## 1. 시스템 개요

### 1.1 프로젝트 구조

```
005_money/
├── 001_python_code/        # 메인 소스 코드
│   ├── main.py             # CLI 진입점
│   ├── gui_app.py          # GUI 진입점
│   ├── config.py           # 중앙 설정 파일
│   ├── config_manager.py   # 동적 설정 관리자
│   ├── strategy.py         # 엘리트 트레이딩 전략 엔진
│   ├── trading_bot.py      # 트레이딩 봇 코어
│   ├── gui_trading_bot.py  # GUI 전용 봇 어댑터
│   ├── bithumb_api.py      # 빗썸 API 래퍼
│   ├── chart_widget.py     # 차트 위젯 (v3.0)
│   ├── signal_history_widget.py  # 신호 히스토리 위젯
│   ├── logger.py           # 다중 채널 로깅 시스템
│   ├── portfolio_manager.py  # 포트폴리오 관리
│   └── run.py, run.sh, run_gui.py  # 실행 스크립트
├── 002_Doc/                # 문서 폴더
├── logs/                   # 로그 파일 저장소
├── pybithumb/              # 외부 빗썸 라이브러리
└── trade_rule/             # 트레이딩 규칙 문서

```

### 1.2 기술 스택

- **언어**: Python 3.7+
- **GUI 프레임워크**: Tkinter (내장)
- **데이터 처리**: Pandas, NumPy
- **시각화**: Matplotlib
- **API 통신**: requests
- **스케줄링**: schedule 라이브러리

---

## 2. 전체 아키텍처

### 2.1 계층형 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────┐
│                    사용자 인터페이스 계층                        │
│  ┌──────────────┐              ┌──────────────────────┐     │
│  │   CLI Mode   │              │     GUI Mode         │     │
│  │   (main.py)  │              │    (gui_app.py)      │     │
│  └──────┬───────┘              └──────────┬───────────┘     │
└─────────┼──────────────────────────────────┼─────────────────┘
          │                                  │
┌─────────┼──────────────────────────────────┼─────────────────┐
│         ▼                                  ▼                 │
│  ┌──────────────┐              ┌──────────────────────┐     │
│  │ TradingBot   │◄─────────────│  GUITradingBot       │     │
│  │ (Core Logic) │              │  (GUI Adapter)       │     │
│  └──────┬───────┘              └──────────┬───────────┘     │
│         │                                  │                 │
│         │        트레이딩 로직 계층          │                 │
│         │                                  │                 │
│  ┌──────┴──────────────────────────────────┴───────┐       │
│  │         TradingStrategy (strategy.py)           │       │
│  │  ┌────────────────────────────────────────┐    │       │
│  │  │  • 8+ 기술적 지표 계산                  │    │       │
│  │  │  • 가중치 기반 신호 생성                │    │       │
│  │  │  • 시장 국면 감지                       │    │       │
│  │  │  • 촛대 패턴 인식                       │    │       │
│  │  │  • 다이버전스 감지                      │    │       │
│  │  │  • Chandelier Exit 계산                │    │       │
│  │  │  • BB Squeeze 감지                     │    │       │
│  │  └────────────────────────────────────────┘    │       │
│  └──────┬──────────────────────────────────────────┘       │
└─────────┼──────────────────────────────────────────────────┘
          │
┌─────────┼──────────────────────────────────────────────────┐
│         ▼                데이터 액세스 계층                   │
│  ┌──────────────┐      ┌──────────────┐                    │
│  │ BithumbAPI   │      │ ConfigManager│                    │
│  │ (API Wrapper)│      │ (Settings)   │                    │
│  └──────┬───────┘      └──────────────┘                    │
│         │                                                   │
│  ┌──────┴──────────────────────────┐                       │
│  │  외부 서비스 / 저장소              │                       │
│  │  • Bithumb REST API             │                       │
│  │  • config.py (중앙 설정)         │                       │
│  │  • logs/ (로그 파일)             │                       │
│  │  • transaction_history.json     │                       │
│  └─────────────────────────────────┘                       │
└──────────────────────────────────────────────────────────────┘
```

### 2.2 주요 설계 원칙

1. **모듈화 (Modularity)**: 각 기능이 독립적인 모듈로 분리
2. **계층 분리 (Separation of Concerns)**: UI, 비즈니스 로직, 데이터 액세스 계층 명확히 구분
3. **느슨한 결합 (Loose Coupling)**: ConfigManager를 통한 설정 주입으로 의존성 최소화
4. **단일 책임 원칙 (Single Responsibility)**: 각 클래스/함수는 하나의 명확한 책임만 가짐
5. **확장 가능성 (Extensibility)**: 새로운 지표나 전략을 쉽게 추가할 수 있는 구조

---

## 3. 핵심 모듈 상세 분석

### 3.1 strategy.py - 엘리트 전략 엔진

**역할**: 시장 데이터를 분석하고 매매 신호를 생성하는 핵심 엔진

**주요 클래스**:
- `TradingStrategy`: 전략 계산 총괄 클래스

**주요 함수** (70+ functions):

#### 기본 지표 계산 함수
```python
# 추세 지표
calculate_moving_average(df, window)           # 이동평균
calculate_macd(df, fast=8, slow=17, signal=9)  # MACD

# 모멘텀 지표
calculate_rsi(df, period=14)                   # RSI
calculate_stochastic(df, k=14, d=3)            # Stochastic

# 변동성 지표
calculate_bollinger_bands(df, window=20, std=2)  # 볼린저 밴드
calculate_atr(df, period=14)                     # ATR
calculate_atr_percent(df, period=14)             # ATR %

# 추세 강도
calculate_adx(df, period=14)                   # ADX

# 거래량
calculate_volume_ratio(df, window=20)          # 거래량 비율
```

#### 엘리트 기능 (v2.0 추가)
```python
# 촛대 패턴 인식
detect_candlestick_patterns(df)
# → 반환: pattern_type, pattern_score, confidence

# 다이버전스 감지
detect_rsi_divergence(df, lookback=30)
detect_macd_divergence(df, lookback=30)
# → 반환: divergence_type ('bullish'/'bearish'), strength

# Chandelier Exit (트레일링 스톱)
calculate_chandelier_exit(df, atr_multiplier=3.0, long_position=True)
# → 반환: stop_price, trailing_status

# BB Squeeze (변동성 압축) 감지
detect_bb_squeeze(df, threshold=0.8, lookback=50)
# → 반환: is_squeezing, squeeze_duration, breakout_direction
```

#### 시장 국면 감지
```python
detect_market_regime(df, adx, atr_percent)
# → 반환 딕셔너리:
#   - regime: 'trending' / 'ranging' / 'transitional'
#   - volatility_level: 'low' / 'normal' / 'high'
#   - recommendation: 'TREND_FOLLOW' / 'MEAN_REVERSION' / 'WAIT'
#   - trend_strength: 0.0 ~ 1.0
```

#### 종합 분석 함수
```python
analyze_market_data(ticker, interval='1h')
# → 반환: 모든 지표 + 국면 분석 결과를 포함하는 거대한 딕셔너리
# 주요 키:
#   - 'price_data': 가격 DataFrame (MA, RSI, MACD 등 계산된 컬럼 포함)
#   - 'current_price', 'short_ma', 'long_ma', 'rsi', 'macd_*'
#   - 'atr', 'atr_percent', 'stoch_k', 'stoch_d', 'adx'
#   - 'bb_upper', 'bb_lower', 'bb_position'
#   - 'regime': 시장 국면 딕셔너리
#   - 'candlestick_pattern': 패턴 딕셔너리
#   - 'rsi_divergence', 'macd_divergence': 다이버전스 딕셔너리
#   - 'chandelier_exit', 'bb_squeeze': 엘리트 기능 딕셔너리
```

#### 신호 생성 함수
```python
generate_weighted_signals(analysis, weights_override=None)
# → 입력: analyze_market_data() 결과
# → 반환 딕셔너리:
#   - 'overall_signal': -1.0 ~ +1.0 (최종 신호 강도)
#   - 'confidence': 0.0 ~ 1.0 (신뢰도)
#   - 'final_action': 'BUY' / 'SELL' / 'HOLD'
#   - 'reason': 결정 이유 (문자열)
#   - 각 지표별 신호: 'macd_signal', 'ma_signal', 'rsi_signal', ...
#   - 각 지표별 강도: 'macd_strength', 'ma_strength', ...
#   - 패턴/다이버전스 보너스 점수
```

**가중치 시스템** (config.py에서 설정):
```python
signal_weights = {
    'macd': 0.35,      # MACD 신호 가중치 (가장 높음)
    'ma': 0.25,        # 이동평균 가중치
    'rsi': 0.20,       # RSI 가중치
    'bb': 0.10,        # 볼린저밴드 가중치
    'volume': 0.10,    # 거래량 가중치
    'pattern': 0.0     # 촛대 패턴 (기본값 0, 조정 가능)
}
# 합계 = 1.0 (100%)
```

**신호 계산 로직**:
```python
# 각 지표의 신호 값 (-1.0 ~ +1.0)
weighted_sum = (
    macd_signal * 0.35 +
    ma_signal * 0.25 +
    rsi_signal * 0.20 +
    bb_signal * 0.10 +
    volume_signal * 0.10 +
    pattern_signal * 0.0  # 기본값
)

# 다이버전스 보너스 가산
if rsi_divergence == 'bullish':
    weighted_sum += 0.15
if macd_divergence == 'bullish':
    weighted_sum += 0.20

# 최종 신호 클리핑
overall_signal = clip(weighted_sum, -1.0, +1.0)

# 신뢰도 계산
confidence = sum(abs(signal) * weight for each indicator) / sum(weights)
```

---

### 3.2 trading_bot.py - 트레이딩 봇 코어

**역할**: 전략 엔진의 신호를 받아 실제 거래를 실행하고 리스크를 관리

**주요 클래스**: `TradingBot`

**핵심 메서드**:

#### 초기화 및 인증
```python
__init__()
# → config 로드
# → logger, api, strategy, portfolio_manager 초기화

authenticate() -> bool
# → 모의 거래 모드: 즉시 True 반환
# → 실제 거래 모드: API 키 검증 (잔고 조회는 비활성화됨)
```

#### 잔고 관리
```python
get_current_balance(currency='KRW') -> float
# → 모의 거래: 가상 잔고 반환 (KRW 100만원, 코인 0.1)
# → 실제 거래: API 호출하여 실제 잔고 조회

calculate_trade_amount(action, ticker, current_price) -> float
# → BUY: 사용 가능 KRW의 99%를 코인 수량으로 변환
# → SELL: 보유 코인의 50% 반환 (분할 매도)
```

#### 거래 실행
```python
execute_trade(ticker, action, amount, current_price) -> bool
# → 모의 거래: 로그 기록 + 거래 내역 JSON 저장
# → 실제 거래: api.place_buy_order() / place_sell_order() 호출
# → TransactionHistory 업데이트
# → MarkdownTransactionLogger 기록
```

#### 메인 트레이딩 로직
```python
run()
# 1. authenticate() 호출
# 2. 무한 루프:
#    a. 현재 시간 확인 (야간 거래 비활성화 시 스킵)
#    b. analyze_and_trade() 호출
#    c. check_interval_minutes만큼 대기
#    d. 긴급 정지 플래그 확인

analyze_and_trade(ticker) -> Dict
# 1. strategy.analyze_market_data() 호출
# 2. strategy.generate_weighted_signals() 호출
# 3. 신호 임계값 확인:
#    - BUY: overall_signal >= 0.5 AND confidence >= 0.6
#    - SELL: overall_signal <= -0.5 AND confidence >= 0.6
# 4. 리스크 관리 검증:
#    - 일일 거래 횟수 확인 (max_daily_trades)
#    - 일일 손실률 확인 (max_daily_loss_pct)
#    - 연속 손실 횟수 확인 (max_consecutive_losses)
# 5. execute_trade() 호출
# 6. 결과 로깅 및 반환
```

**리스크 관리 규칙**:
- 일일 최대 거래 횟수: 5회 (기본값, 조정 가능)
- 일일 최대 손실률: 3.0% (초과 시 거래 중단)
- 연속 최대 손실 횟수: 3회 (초과 시 거래 중단)
- ATR 기반 동적 손절: `entry_price - (ATR × 2.0)`

---

### 3.3 gui_app.py - GUI 애플리케이션

**역할**: 사용자 친화적인 그래픽 인터페이스 제공

**주요 클래스**: `TradingBotGUI`

**GUI 구조** (4-Column Layout + 4 Tabs):

#### 메인 창 (1400x850)
- **상단 제어 패널**: 봇 시작/정지 버튼, 상태 표시, 모드 표시
- **탭 영역**:
  1. **거래 현황 탭**: 4-컬럼 레이아웃
  2. **실시간 차트 탭**: 차트 위젯
  3. **신호 히스토리 탭**: 과거 신호 기록
  4. **거래 내역 탭**: 거래 로그 테이블

#### 거래 현황 탭 - 4-컬럼 구성

**Column 1 (스크롤 가능)**:
- 📊 거래 요약 패널
- 📊 거래 상태 패널 (코인, 가격, 평균 매수가, 보유 수량, 대기 주문)
- 🕯️ 캔들스틱 패턴 패널 (패턴 타입, 점수, 신뢰도)
- 📈 다이버전스 패널 (RSI/MACD 다이버전스 감지 결과)
- 🔵 시장 국면 패널 (Trending/Ranging/Transitional, 변동성, ADX)

**Column 2 (스크롤 가능)**:
- ⚙️ 엘리트 전략 설정 패널
  - 전략 프리셋 선택 (Balanced/Trend Following/Mean Reversion/Custom)
  - 8개 지표 체크박스 + 값 표시 (MA, RSI, BB, MACD, Volume, Stochastic, ATR, ADX)
  - 기본 설정 (거래 코인, 캔들 간격, 체크 간격, 거래 금액)
  - 설정 적용 버튼
- 🎯 종합 신호 패널 (신호 강도, 신뢰도, 최종 액션, 이유)

**Column 3 (스크롤 가능)**:
- ⚖️ 신호 가중치 조정 패널
  - 각 지표별 가중치 슬라이더 (MACD, MA, RSI, BB, Volume, Pattern)
  - 실시간 가중치 합계 표시
  - 프리셋 저장/로드 기능

**Column 4 (스크롤 가능)**:
- ⚠️ ATR 기반 리스크 관리 패널
  - 현재 ATR 값 및 비율
  - 손절가 계산 (entry - ATR × multiplier)
  - 익절가 1, 2 계산
  - R:R 비율 표시
- 💰 수익 현황 패널
  - 오늘 수익, 총 수익
  - 오늘 거래 횟수, 총 거래 횟수
  - 승률, 평균 수익률

**하단 (고정)**:
- 📝 실시간 로그 패널 (ScrolledText, 최대 1000줄)

#### 주요 업데이트 함수
```python
update_gui()
# → 100ms마다 호출 (self.root.after(100))
# → update_price() 호출 (5초마다)
# → update_log_display() 호출 (로그 큐에서 새 메시지 가져오기)
# → 봇 상태 업데이트 (is_running, last_action 등)

update_price()
# → get_ticker() API 호출하여 현재 가격 갱신
# → 5초마다 실행

update_analysis_display(analysis, signals)
# → 전략 분석 결과를 GUI에 반영
# → 각 지표 LED 상태 업데이트 (빨강/파랑/회색)
# → 신호 강도 프로그레스 바 업데이트
# → 패턴, 다이버전스, 시장 국면 정보 표시
```

#### 봇 제어 함수
```python
start_bot()
# → GUITradingBot 인스턴스 생성
# → 별도 스레드에서 bot.run() 실행
# → 시작 버튼 비활성화, 정지 버튼 활성화
# → is_running = True

stop_bot()
# → bot.stop() 호출 (긴급 정지 플래그 설정)
# → 스레드 종료 대기
# → 시작 버튼 활성화, 정지 버튼 비활성화
# → is_running = False
```

---

### 3.4 chart_widget.py - 실시간 차트 위젯 (v3.0)

**역할**: 가격 차트와 기술적 지표를 시각화

**주요 클래스**: `ChartWidget`

**구조**:
- **상단 제어 패널**: 새로고침 버튼 + 지표 체크박스 (13개)
- **차트 영역**: Matplotlib 기반 다이나믹 서브플롯

**지원 지표 표시** (체크박스 on/off):
1. **MA** (Moving Average): 메인 차트 오버레이 (주황색/보라색 선)
2. **RSI**: 별도 서브플롯, 30/70 선, 과매수/과매도 영역 색칠
3. **BB** (Bollinger Bands): 메인 차트 오버레이 (회색 점선 + 투명 영역)
4. **MACD**: 별도 서브플롯, MACD/Signal 선 + 히스토그램
5. **Volume**: 별도 서브플롯, 상승/하락 색상 구분 바 차트
6. **Stochastic**: 정보 박스에 K/D 값 표시
7. **ATR**: 정보 박스에 ATR 값 및 % 표시
8. **ADX**: 정보 박스에 ADX 값 및 추세 강도 표시
9. **Candlestick Patterns**: 메인 차트에 마커 및 라벨 표시
10. **RSI Divergence**: RSI 서브플롯에 다이버전스 라인 표시
11. **MACD Divergence**: MACD 서브플롯에 다이버전스 라인 표시
12. **Chandelier Stop**: 메인 차트에 수평선 표시 (상태별 색상)
13. **BB Squeeze**: 메인 차트에 배경 음영 영역 표시

**핵심 메서드**:
```python
load_and_prepare_data() -> bool
# → strategy.analyze_market_data() 호출
# → 최근 100개 캔들 데이터 추출
# → self.df, self.analysis, self.signals 저장

update_chart()
# → 활성화된 서브플롯 개수 계산
# → GridSpec으로 동적 레이아웃 생성 (height_ratios=[3, 1, 1, ...])
# → plot_candlesticks() 호출
# → 체크박스 상태에 따라 지표 플롯 함수 호출
# → tight_layout() 적용
# → canvas.draw() 실행

on_indicator_toggle()
# → 체크박스 상태 변경 시 자동 호출
# → update_chart() 즉시 실행 (새로고침 없이 반영)
```

**차트 v3.0의 핵심 개선사항**:
- **Pure Matplotlib 구현**: mplfinance 의존성 제거로 x축 압축 문제 해결
- **동적 서브플롯**: 활성화된 지표에 따라 레이아웃 자동 조정
- **실시간 토글**: 체크박스 변경 즉시 반영 (새로고침 버튼 불필요)
- **13개 지표 지원**: 기본 + 엘리트 기능 모두 시각화

---

### 3.5 bithumb_api.py - API 래퍼

**역할**: 빗썸 거래소 API 통신 추상화

**주요 함수**:
```python
get_ticker(ticker='BTC') -> Dict
# → 공개 API: 현재 시세 조회
# → 반환: {'opening_price', 'closing_price', 'min_price', 'max_price', 'volume', ...}

get_candlestick(ticker='BTC', interval='1h') -> pd.DataFrame
# → 공개 API: OHLCV 캔들 데이터 조회
# → interval: '1m', '5m', '30m', '1h', '6h', '12h', '24h'
# → 반환: DataFrame with columns ['time', 'open', 'high', 'low', 'close', 'volume']

place_buy_order(ticker, units) -> Dict
# → 비공개 API: 시장가 매수 주문
# → 인증 필요 (API 키 + 서명)

place_sell_order(ticker, units) -> Dict
# → 비공개 API: 시장가 매도 주문

get_balance(currency='ALL') -> Dict
# → 비공개 API: 잔고 조회
# → 반환: {'available_krw', 'available_btc', ...}
```

**인증 시스템**:
- HMAC-SHA512 기반 서명 생성
- nonce (timestamp) 사용하여 재전송 공격 방지
- 환경변수 또는 config.py에서 API 키 로드

---

### 3.6 logger.py - 다중 채널 로깅 시스템

**역할**: 다양한 이벤트를 구조화하여 기록

**주요 클래스**:

#### TradingLogger
- **파일별 로그 분류**:
  - `trading_{YYYYMMDD}.log`: 메인 로그 (모든 이벤트)
  - `decision_{YYYYMMDD}.log`: 전략 결정 로그
  - `error_{YYYYMMDD}.log`: 오류 로그
  - `transaction_{YYYYMMDD}.log`: 거래 실행 로그

- **주요 메서드**:
```python
log_analysis(ticker, analysis)
# → 시장 분석 결과 기록

log_signal(ticker, signal, action, reason)
# → 신호 생성 결과 기록

log_trade_execution(ticker, action, amount, price, order_id, success)
# → 거래 실행 결과 기록

log_error(message, exception=None)
# → 오류 발생 기록 (스택 트레이스 포함)
```

#### TransactionHistory
- **거래 내역 JSON 관리**:
  - 파일: `logs/transaction_history.json`
  - 구조: 리스트 형태, 각 거래는 딕셔너리
  - 자동 저장/로드 기능

- **주요 메서드**:
```python
add_transaction(ticker, action, amount, price, order_id, fee, success)
# → 새 거래 추가 및 즉시 파일 저장

get_transactions(ticker=None, action=None, start_date=None, end_date=None)
# → 조건에 맞는 거래 필터링 조회

calculate_total_profit(ticker=None)
# → 총 수익 계산

calculate_win_rate(ticker=None)
# → 승률 계산
```

#### MarkdownTransactionLogger
- **마크다운 형식 거래 로그**:
  - 파일: `logs/trading_history.md`
  - 사람이 읽기 쉬운 테이블 형식
  - 거래 시각화 및 분석용

---

### 3.7 config_manager.py - 동적 설정 관리자

**역할**: 런타임 중 설정 변경을 안전하게 처리

**주요 클래스**: `ConfigManager`

**기능**:
```python
get_config() -> Dict
# → 현재 전체 설정 반환 (config.py 기반)

update_setting(section, key, value) -> bool
# → 특정 설정값 변경
# → 검증 수행 (타입, 범위 확인)
# → 변경 사항 로깅

switch_interval_preset(interval: str)
# → '30m', '1h', '6h', '12h', '24h' 프리셋으로 전환
# → 해당 간격에 최적화된 모든 지표 파라미터 자동 조정

update_signal_weights(weights: Dict)
# → 신호 가중치 업데이트
# → 합계 1.0 검증
# → 정규화 수행 (필요시)
```

**검증 규칙**:
- 가격/금액: 0 이상
- 비율: 0.0 ~ 1.0 또는 0 ~ 100
- 기간: 정수, 최소 1 이상
- 가중치 합계: 1.0 (허용 오차 ±0.01)

---

## 4. 데이터 흐름

### 4.1 매매 사이클 전체 플로우

```
[시작]
  │
  ├─> [1. 데이터 수집]
  │    │
  │    ├─> bithumb_api.get_candlestick(ticker, interval)
  │    │    → OHLCV DataFrame 반환 (최근 100~200 캔들)
  │    │
  │    └─> bithumb_api.get_ticker(ticker)
  │         → 현재 가격 정보 반환
  │
  ├─> [2. 지표 계산] (strategy.py)
  │    │
  │    ├─> calculate_moving_average(df, 20) → short_ma
  │    ├─> calculate_moving_average(df, 50) → long_ma
  │    ├─> calculate_rsi(df, 14) → rsi
  │    ├─> calculate_macd(df, 8, 17, 9) → macd_line, signal, histogram
  │    ├─> calculate_bollinger_bands(df, 20, 2) → bb_upper, bb_mid, bb_lower
  │    ├─> calculate_atr(df, 14) → atr, atr_percent
  │    ├─> calculate_stochastic(df, 14, 3) → stoch_k, stoch_d
  │    ├─> calculate_adx(df, 14) → adx
  │    ├─> calculate_volume_ratio(df, 20) → volume_ratio
  │    │
  │    └─> DataFrame에 모든 지표 컬럼 추가
  │
  ├─> [3. 엘리트 기능 계산] (v2.0)
  │    │
  │    ├─> detect_candlestick_patterns(df)
  │    │    → pattern_type, pattern_score, confidence
  │    │
  │    ├─> detect_rsi_divergence(df, 30)
  │    │    → divergence_type ('bullish'/'bearish'), strength
  │    │
  │    ├─> detect_macd_divergence(df, 30)
  │    │    → divergence_type, strength
  │    │
  │    ├─> calculate_chandelier_exit(df, 3.0)
  │    │    → stop_price, trailing_status
  │    │
  │    └─> detect_bb_squeeze(df, 0.8, 50)
  │         → is_squeezing, duration, breakout_direction
  │
  ├─> [4. 시장 국면 감지]
  │    │
  │    └─> detect_market_regime(df, adx, atr_percent)
  │         → regime, volatility_level, recommendation, trend_strength
  │
  ├─> [5. 신호 생성]
  │    │
  │    ├─> 각 지표별 신호 값 계산 (-1.0 ~ +1.0):
  │    │    • macd_signal = f(macd_line, signal_line, histogram)
  │    │    • ma_signal = f(short_ma, long_ma, current_price)
  │    │    • rsi_signal = f(rsi, 30, 70)
  │    │    • bb_signal = f(bb_position)
  │    │    • volume_signal = f(volume_ratio)
  │    │    • pattern_signal = pattern_score (if enabled)
  │    │
  │    ├─> 가중치 적용 및 합산:
  │    │    overall_signal = Σ(signal_i × weight_i)
  │    │
  │    ├─> 다이버전스 보너스 가산:
  │    │    • RSI bullish divergence: +0.15
  │    │    • MACD bullish divergence: +0.20
  │    │
  │    ├─> 신뢰도 계산:
  │    │    confidence = Σ(|signal_i| × weight_i) / Σ(weight_i)
  │    │
  │    └─> 최종 액션 결정:
  │         IF overall_signal >= 0.5 AND confidence >= 0.6 → BUY
  │         ELIF overall_signal <= -0.5 AND confidence >= 0.6 → SELL
  │         ELSE → HOLD
  │
  ├─> [6. 리스크 관리 검증]
  │    │
  │    ├─> 일일 거래 횟수 확인 (max_daily_trades)
  │    ├─> 일일 손실률 확인 (max_daily_loss_pct)
  │    ├─> 연속 손실 횟수 확인 (max_consecutive_losses)
  │    └─> ATR 기반 손절가 계산 (entry - ATR × multiplier)
  │
  ├─> [7. 거래 실행] (IF 모든 조건 만족)
  │    │
  │    ├─> [모의 거래 모드]
  │    │    ├─> 로그 기록 (logger.log_trade_execution)
  │    │    ├─> 거래 내역 저장 (transaction_history.add_transaction)
  │    │    └─> 마크다운 로그 (markdown_logger.log_transaction)
  │    │
  │    └─> [실제 거래 모드]
  │         ├─> API 인증 검증
  │         ├─> bithumb_api.place_buy_order() / place_sell_order()
  │         ├─> 주문 결과 확인 (order_id, status)
  │         ├─> 거래 내역 저장
  │         └─> 로그 기록
  │
  ├─> [8. 결과 기록]
  │    │
  │    ├─> trading_{date}.log: 전체 과정 로그
  │    ├─> decision_{date}.log: 신호 생성 결정 로그
  │    ├─> transaction_{date}.log: 거래 실행 로그
  │    ├─> transaction_history.json: 구조화된 거래 데이터
  │    └─> trading_history.md: 마크다운 거래 로그
  │
  ├─> [9. GUI 업데이트] (GUI 모드인 경우)
  │    │
  │    ├─> log_queue에 메시지 추가
  │    ├─> bot_status 딕셔너리 업데이트
  │    └─> update_gui()에서 100ms마다 반영
  │
  └─> [10. 대기]
       │
       ├─> check_interval_minutes만큼 대기 (기본 15분)
       └─> 긴급 정지 플래그 확인 후 [1]로 돌아가기
```

### 4.2 GUI 이벤트 루프

```
[GUI 시작]
  │
  ├─> [Tkinter 메인 루프 시작]
  │    │
  │    └─> root.mainloop()
  │
  ├─> [100ms 타이머] (self.root.after(100, self.update_gui))
  │    │
  │    ├─> [로그 업데이트]
  │    │    ├─> log_queue에서 메시지 가져오기 (non-blocking)
  │    │    └─> log_text_widget에 삽입 (최대 1000줄 유지)
  │    │
  │    ├─> [상태 업데이트]
  │    │    ├─> bot_status 딕셔너리 읽기
  │    │    ├─> 가격, 보유량, 평균 매수가 표시 갱신
  │    │    └─> 신호 LED 상태 갱신
  │    │
  │    └─> [5초 타이머 체크]
  │         └─> IF (현재시각 - 마지막 가격 업데이트) > 5초:
  │              ├─> get_ticker() API 호출
  │              └─> current_price_var 업데이트
  │
  ├─> [봇 스레드 실행] (start_bot() 호출 시)
  │    │
  │    ├─> threading.Thread(target=bot.run, daemon=True).start()
  │    │
  │    └─> [봇 스레드 내부]
  │         ├─> 무한 루프 (while not stop_flag)
  │         ├─> analyze_and_trade() 호출
  │         ├─> 결과를 log_queue에 추가
  │         └─> time.sleep(check_interval_minutes * 60)
  │
  └─> [사용자 이벤트 처리]
       ├─> 버튼 클릭 (시작/정지)
       ├─> 체크박스 토글 (지표 활성화/비활성화)
       ├─> 슬라이더 조정 (가중치 변경)
       └─> 탭 전환 (거래 현황 ↔ 차트 ↔ 신호 히스토리 ↔ 거래 내역)
```

---

## 5. 의존성 관계

### 5.1 모듈 의존성 그래프

```
main.py
  └─> trading_bot.py
       ├─> config.py
       ├─> logger.py
       ├─> strategy.py
       │    ├─> pandas, numpy
       │    ├─> bithumb_api.py
       │    └─> config.py
       ├─> bithumb_api.py
       │    ├─> requests
       │    └─> config.py
       └─> portfolio_manager.py
            ├─> bithumb_api.py
            └─> logger.py

gui_app.py
  ├─> gui_trading_bot.py
  │    └─> trading_bot.py (상속)
  ├─> chart_widget.py
  │    ├─> matplotlib
  │    ├─> strategy.py
  │    └─> config.py
  ├─> signal_history_widget.py
  │    └─> tkinter
  ├─> config_manager.py
  │    └─> config.py
  └─> logger.py

External Dependencies:
  ├─> pybithumb/ (깃허브 서브모듈)
  ├─> pandas (데이터 처리)
  ├─> numpy (수치 계산)
  ├─> matplotlib (차트)
  ├─> requests (HTTP)
  ├─> schedule (스케줄링)
  └─> tkinter (GUI, Python 내장)
```

### 5.2 순환 의존성 방지 설계

- **config.py는 다른 모듈에 의존하지 않음** (순수 설정 데이터)
- **logger.py는 비즈니스 로직에 의존하지 않음** (순수 로깅 유틸리티)
- **bithumb_api.py는 strategy나 bot에 의존하지 않음** (순수 API 래퍼)
- **strategy.py는 bot에 의존하지 않음** (단방향 호출: bot → strategy)
- **GUI는 CLI 로직에 의존하지 않음** (gui_trading_bot이 어댑터 역할)

---

## 6. 설정 관리 시스템

### 6.1 설정 파일 구조 (config.py)

```python
# API 인증 정보 (환경변수 우선)
BITHUMB_CONNECT_KEY = os.getenv("BITHUMB_CONNECT_KEY", "YOUR_CONNECT_KEY")
BITHUMB_SECRET_KEY = os.getenv("BITHUMB_SECRET_KEY", "YOUR_SECRET_KEY")

# 거래 설정
TRADING_CONFIG = {
    'target_ticker': 'BTC',
    'trade_amount_krw': 10000,
    'min_trade_amount': 5000,
    'max_trade_amount': 100000,
    'stop_loss_percent': 5.0,
    'take_profit_percent': 10.0,
    'trading_fee_rate': 0.0025,
}

# 전략 설정 (150+ 파라미터)
STRATEGY_CONFIG = {
    'candlestick_interval': '1h',  # DEFAULT
    'short_ma_window': 20,
    'long_ma_window': 50,
    'rsi_period': 14,
    'rsi_overbought': 70,
    'rsi_oversold': 30,
    'macd_fast': 8,
    'macd_slow': 17,
    'macd_signal': 9,
    'atr_period': 14,
    'atr_stop_multiplier': 2.0,
    'chandelier_atr_multiplier': 3.0,
    'stoch_k_period': 14,
    'stoch_d_period': 3,
    'adx_period': 14,
    'bb_period': 20,
    'bb_std': 2.0,
    'volume_window': 20,

    # 엘리트 기능 (v2.0)
    'pattern_detection_enabled': True,
    'divergence_lookback': 30,
    'divergence_detection_enabled': True,
    'bb_squeeze_threshold': 0.8,
    'bb_squeeze_lookback': 50,

    # 신호 가중치
    'signal_weights': {
        'macd': 0.35,
        'ma': 0.25,
        'rsi': 0.20,
        'bb': 0.10,
        'volume': 0.10,
        'pattern': 0.0
    },

    # 임계값
    'confidence_threshold': 0.6,
    'signal_threshold': 0.5,

    # 리스크 관리
    'max_daily_loss_pct': 3.0,
    'max_consecutive_losses': 3,
    'max_daily_trades': 5,

    # 간격별 프리셋 (5개: 30m, 1h, 6h, 12h, 24h)
    'interval_presets': {
        '30m': { ... },  # 30분봉 최적 파라미터
        '1h': { ... },   # 1시간봉 최적 파라미터 (DEFAULT)
        '6h': { ... },
        '12h': { ... },
        '24h': { ... }
    }
}

# 스케줄링 설정
SCHEDULE_CONFIG = {
    'check_interval_minutes': 15,
    'enable_night_trading': False,
    'interval_check_periods': {
        '30m': 10,
        '1h': 15,
        '6h': 60,
        '12h': 120,
        '24h': 240
    }
}

# 로깅 설정
LOGGING_CONFIG = {
    'log_level': 'INFO',
    'log_dir': 'logs',
    'max_log_files': 30,
}

# 안전 설정
SAFETY_CONFIG = {
    'dry_run': False,
    'test_mode': False,
    'max_daily_trades': 10,
    'emergency_stop': False,
}
```

### 6.2 설정 접근 패턴

**정적 접근** (프로그램 시작 시):
```python
import config

interval = config.STRATEGY_CONFIG['candlestick_interval']
weights = config.STRATEGY_CONFIG['signal_weights']
dry_run = config.SAFETY_CONFIG['dry_run']
```

**동적 접근** (런타임 변경):
```python
from config_manager import ConfigManager

manager = ConfigManager()
current_config = manager.get_config()

# 설정 변경
manager.update_setting('strategy', 'rsi_period', 21)
manager.update_signal_weights({'macd': 0.40, 'ma': 0.30, ...})
manager.switch_interval_preset('30m')
```

---

## 7. 로깅 및 모니터링

### 7.1 로그 파일 구조

```
logs/
├── trading_20251002.log          # 메인 로그 (모든 이벤트)
├── decision_20251002.log         # 전략 결정 로그
├── error_20251002.log            # 오류 로그
├── transaction_20251002.log      # 거래 실행 로그
├── transaction_history.json      # 구조화된 거래 데이터
└── trading_history.md            # 마크다운 거래 로그
```

### 7.2 로그 레벨 및 포맷

**로그 레벨**:
- `DEBUG`: 상세 디버깅 정보 (개발용)
- `INFO`: 일반 정보 (정상 작동 확인)
- `WARNING`: 경고 (주의 필요하지만 치명적이지 않음)
- `ERROR`: 오류 (기능 실패, 조치 필요)
- `CRITICAL`: 치명적 오류 (프로그램 중단)

**로그 포맷**:
```
2025-10-02 14:32:15,123 | INFO | trading_bot | BTC 시장 분석 시작 (간격: 1h)
2025-10-02 14:32:16,456 | INFO | strategy | 신호 생성 완료: overall_signal=0.72, confidence=0.81, action=BUY
2025-10-02 14:32:17,789 | INFO | trading_bot | 매수 실행: 0.000234 BTC @ 52,340,000 KRW
2025-10-02 14:32:18,012 | ERROR | bithumb_api | API 호출 실패: Connection timeout
```

### 7.3 거래 내역 JSON 구조

```json
{
  "transactions": [
    {
      "timestamp": "2025-10-02T14:32:17",
      "ticker": "BTC",
      "action": "BUY",
      "amount": 0.000234,
      "price": 52340000,
      "total_value": 12247.56,
      "fee": 30.62,
      "order_id": "ORD123456789",
      "success": true,
      "signal_strength": 0.72,
      "confidence": 0.81,
      "indicators": {
        "macd": 0.85,
        "ma": 0.60,
        "rsi": 0.45,
        "bb": 0.70,
        "volume": 0.90
      }
    },
    ...
  ]
}
```

---

## 8. 보안 고려사항

### 8.1 API 키 관리

**권장 방법**:
1. **환경변수 사용** (최우선):
   ```bash
   export BITHUMB_CONNECT_KEY="실제_키"
   export BITHUMB_SECRET_KEY="실제_키"
   ```

2. **.env 파일 사용** (python-dotenv):
   ```
   # .env 파일 (반드시 .gitignore에 추가)
   BITHUMB_CONNECT_KEY=실제_키
   BITHUMB_SECRET_KEY=실제_키
   ```

3. **하드코딩 금지**:
   - config.py에 실제 키 입력 절대 금지
   - 실수로 입력한 경우 즉시 키 재발급
   - config.py를 .gitignore에 추가

### 8.2 API 권한 설정

**빗썸 API 권한** (최소 권한 원칙):
- ✅ **자산 조회**: 필수
- ✅ **거래**: 필수
- ❌ **출금**: 절대 활성화 금지 (보안상 매우 위험)

### 8.3 모의 거래 모드

**개발/테스트 시 필수**:
```python
# config.py
SAFETY_CONFIG = {
    'dry_run': True,  # 모의 거래 모드 활성화
    'test_mode': False,
}
```

**모의 거래 모드 특징**:
- API 호출 없이 로컬에서 시뮬레이션
- 거래 내역 로그는 정상 기록
- 실제 자금 손실 없음
- 전략 테스트 및 버그 수정용

### 8.4 긴급 정지 메커니즘

**GUI 정지 버튼**:
- `stop_bot()` 호출 → `bot.stop()` → `emergency_stop = True`
- 현재 루프 완료 후 즉시 종료

**설정 파일 긴급 정지**:
```python
# config.py
SAFETY_CONFIG = {
    'emergency_stop': True,  # True로 변경 시 봇 즉시 중단
}
```

### 8.5 리스크 제한

**다중 안전장치**:
1. **일일 최대 거래 횟수**: 5회 (기본값)
2. **일일 최대 손실률**: 3.0% (초과 시 거래 중단)
3. **연속 최대 손실 횟수**: 3회 (초과 시 거래 중단)
4. **ATR 기반 동적 손절**: 변동성에 따라 자동 조정
5. **최소 거래 금액**: 5,000원 (과소 거래 방지)

---

## 부록

### A. 주요 파일 역할 요약

| 파일명 | 역할 | 주요 클래스/함수 | LOC |
|--------|------|-----------------|-----|
| strategy.py | 전략 엔진 | TradingStrategy, 70+ functions | 2500+ |
| trading_bot.py | 봇 코어 | TradingBot | 650 |
| gui_app.py | GUI 메인 | TradingBotGUI | 3300 |
| gui_trading_bot.py | GUI 어댑터 | GUITradingBot | 500 |
| chart_widget.py | 차트 위젯 | ChartWidget (v3.0) | 820 |
| bithumb_api.py | API 래퍼 | BithumbAPI | 480 |
| logger.py | 로깅 시스템 | TradingLogger, TransactionHistory | 400 |
| config.py | 중앙 설정 | 150+ parameters | 280 |
| config_manager.py | 동적 설정 관리 | ConfigManager | 700 |

### B. 성능 최적화 포인트

1. **데이터 캐싱**: analyze_market_data() 결과를 재사용하여 중복 계산 방지
2. **배치 지표 계산**: 모든 지표를 한 번에 계산하여 DataFrame 반복 최소화
3. **로그 큐 크기 제한**: GUI 로그 큐 최대 1000개 유지하여 메모리 누수 방지
4. **차트 업데이트 최적화**: 체크박스 변경 시에만 재렌더링, 불필요한 업데이트 방지
5. **스레드 분리**: GUI 메인 루프와 봇 실행 로직을 별도 스레드로 분리하여 UI 블로킹 방지

### C. 확장 가능성

**새로운 지표 추가 방법**:
1. `strategy.py`에 `calculate_NEW_INDICATOR(df, params)` 함수 추가
2. `analyze_market_data()`에서 새 지표 호출 및 결과 저장
3. `generate_weighted_signals()`에 새 지표 신호 로직 추가
4. `config.py`의 `signal_weights`에 새 지표 가중치 추가
5. `gui_app.py`에 새 지표 표시 UI 추가 (선택)
6. `chart_widget.py`에 새 지표 시각화 추가 (선택)

**새로운 거래소 지원**:
1. `{exchange}_api.py` 파일 생성 (bithumb_api.py 참고)
2. 동일한 인터페이스 구현 (get_ticker, get_candlestick, place_order 등)
3. `config.py`에 거래소 선택 옵션 추가
4. `trading_bot.py`에서 거래소별 API 선택 로직 추가

---

**문서 버전**: 3.0
**작성일**: 2025년 10월 2일
**작성자**: Claude (Anthropic)
**관련 문서**:
- [설정 가이드](./설정_가이드.md)
- [트레이딩 전략 가이드](./트레이딩_전략_가이드.md)
- [GUI 사용자 가이드](./GUI_사용자_가이드.md)
