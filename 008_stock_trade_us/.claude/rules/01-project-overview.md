# 프로젝트 개요

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    퀀트 자동매매 시스템                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│  │   Telegram  │────▶│   System    │────▶│    Quant    │   │
│  │     Bot     │     │ Controller  │     │   Engine    │   │
│  └─────────────┘     └─────────────┘     └─────────────┘   │
│         │                   │                   │           │
│         │                   ▼                   │           │
│         │           ┌─────────────┐             │           │
│         │           │    Auto     │             │           │
│         │           │   Manager   │             │           │
│         │           └─────────────┘             │           │
│         │                   │                   │           │
│         ▼                   ▼                   ▼           │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                      KIS API                          │ │
│  │        (한국투자증권 Open API - REST/WebSocket)        │ │
│  └───────────────────────────────────────────────────────┘ │
│                             │                               │
│                             ▼                               │
│  ┌───────────────────────────────────────────────────────┐ │
│  │                     KOSPI200                          │ │
│  │              (200개 종목 유니버스)                      │ │
│  └───────────────────────────────────────────────────────┘ │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 핵심 컴포넌트

### 1. TelegramBot (원격 제어 인터페이스)
- 사용자 명령 수신
- 시스템 상태 전송
- 알림 발송

### 2. SystemController (중앙 제어기)
- 싱글톤 패턴
- 상태 관리 (STOPPED, RUNNING, PAUSED, EMERGENCY_STOP)
- 설정 관리
- 콜백 기반 엔진 연동

### 3. QuantEngine (자동매매 엔진)
- 스케줄 기반 실행
- 스크리닝 → 주문 → 모니터링

### 4. AutoManager (자동 관리)
- 월간 모니터링 (매월 1일)
- 반기 최적화 (1월, 7월)
- 가중치 자동 업데이트

## 데이터 저장소

| 파일 | 용도 |
|------|------|
| `config/optimal_weights.json` | 최적 팩터 가중치 |
| `config/system_config.json` | 시스템 설정 |
| `data/quant/system_state.json` | 시스템 상태 |
| `data/quant/positions.json` | 보유 포지션 |
| `logs/daemon_YYYYMMDD.log` | 일별 로그 |

## 실행 모드

1. **Dry-Run 모드** (기본값)
   - 실제 주문 없이 시뮬레이션
   - 모든 기능 테스트 가능

2. **모의투자 모드** (기본값)
   - KIS 모의투자 계좌 사용
   - 실제 자금 위험 없음

3. **실전투자 모드** (주의!)
   - 실제 주문 실행
   - `--real --no-dry-run` 옵션 필요

## 설정 동기화 (2024-12 추가)

```
┌─────────────────────────────────────────────────────────────┐
│                    설정 동기화 흐름                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐   │
│  │  Telegram   │────▶│   System    │────▶│    Quant    │   │
│  │  Commands   │     │ Controller  │     │   Engine    │   │
│  └─────────────┘     └─────────────┘     └─────────────┘   │
│        │                    │                    │          │
│        │                    ▼                    │          │
│        │            ┌─────────────┐              │          │
│        │            │ system_     │              │          │
│        └───────────▶│ config.json │◀─────────────┘          │
│                     └─────────────┘                         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**동기화 특징:**
- 텔레그램 명령으로 변경한 설정은 `system_config.json`에 자동 저장
- 데몬 재시작 시 `SystemController`에서 설정 로드
- `QuantEngine`은 `SystemController` 설정 사용 (설정 일관성 보장)
- 명령줄 인자(`--no-dry-run`, `--real`)도 `SystemController`에 저장

## 일일 운영 흐름 (Trading Day Flow)

```
┌────────────────────────────────────────────────────────────┐
│                    월요일 장 시작 예시                        │
├──────────┬─────────────────────────────────────────────────┤
│  08:30   │  🌅 장 전 처리 (_on_pre_market)                  │
│          │  • 평일 여부 확인                                 │
│          │  • 포지션 없음 → 초기 스크리닝 실행                │
│          │  • 리밸런싱 일 → 종목 교체 스크리닝                │
│          │  • 📱 텔레그램: "장 전 처리 시작"                  │
├──────────┼─────────────────────────────────────────────────┤
│  09:00   │  🔔 장 시작 (execute_pending_orders)             │
│          │  • 대기 주문 일괄 실행                            │
│          │  • 📱 텔레그램: "장 시작 - N개 주문 실행"          │
│          │  • 포지션 업데이트                                │
├──────────┼─────────────────────────────────────────────────┤
│  09:05~  │  📊 포지션 모니터링 (5분 간격)                    │
│          │  • 각 포지션 손익률 계산                          │
│          │  • 손절 -7% / 익절 +10% 조건 체크                 │
│          │  • 조건 충족 시 자동 매도                         │
├──────────┼─────────────────────────────────────────────────┤
│  15:20   │  🌙 장 마감 (_on_market_close)                   │
│          │  • 일일 리포트 생성                               │
│          │  • 📱 텔레그램: 수익률, 보유 종목 알림             │
└──────────┴─────────────────────────────────────────────────┘
```

**주말/휴일 처리:**
- 데몬이 주말에 시작되면 초기 스크리닝 스킵
- 다음 평일 08:30에 자동으로 스크리닝 실행
- 포지션 없음 감지 시 즉시 초기 설정 수행

## 텔레그램 알림 이벤트

| 시점 | 알림 내용 |
|------|----------|
| 데몬 시작 | 🚀 퀀트 시스템 시작 (설정 정보) |
| 장 전 처리 | 🌅 장 전 처리 시작 |
| 초기 스크리닝 | 📋 포지션 없음 - 초기 스크리닝 실행 |
| 스크리닝 완료 | ✅ 초기 스크리닝 완료 - N개 주문 생성 |
| 장 시작 | 🔔 장 시작 - 대기 주문 N개 실행 중 |
| 매수/매도 | 🟢/🔴 종목명 매수/매도 알림 |
| 장 마감 | 🌙 장 마감 - 일일 리포트 |
| 데몬 종료 | 🛑 퀀트 시스템 종료 |
